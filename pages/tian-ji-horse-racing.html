<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”°å¿Œèµ›é©¬æ¨¡æ‹Ÿå™¨ - è¿™æ˜¯ç ´åè§„åˆ™è¿˜æ˜¯åšå¼ˆæ™ºæ…§ï¼Ÿ</title>
  <script src="../components/header.js" defer></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .back-link {
      display: inline-block;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    .back-link:hover { text-decoration: underline; }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.8rem;
      background: linear-gradient(135deg, #ffd93d, #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle {
      text-align: center;
      color: rgba(255,255,255,0.7);
      margin-bottom: 25px;
      font-size: 0.95rem;
    }
    .card {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .question-box {
      background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,217,61,0.1));
      border-left: 4px solid #ff6b6b;
      padding: 15px 20px;
      border-radius: 0 12px 12px 0;
      margin-bottom: 20px;
      font-size: 1.05rem;
      line-height: 1.8;
    }
    .question-box strong { color: #ffd93d; }
    
    /* æ¨¡å¼åˆ‡æ¢ */
    .mode-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .mode-tab {
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      background: rgba(0,0,0,0.2);
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      font-size: 0.9rem;
    }
    .mode-tab:hover { border-color: #ffd93d; }
    .mode-tab.active {
      border-color: #4ade80;
      background: rgba(74,222,128,0.15);
      color: #4ade80;
    }
    .mode-tab .icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }
    
    /* æ‹–æ‹½æ’å…µ */
    .drag-section {
      margin: 20px 0;
    }
    .drag-title {
      color: #ffd93d;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }
    .drag-hint {
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      margin-bottom: 15px;
    }
    .horse-pool {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .draggable-horse {
      width: 80px;
      height: 100px;
      background: rgba(0,0,0,0.3);
      border: 2px dashed rgba(255,255,255,0.3);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: grab;
      transition: all 0.2s;
      user-select: none;
    }
    .draggable-horse:hover {
      border-color: #ffd93d;
      transform: scale(1.05);
    }
    .draggable-horse.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .draggable-horse .horse-emoji { font-size: 2rem; }
    .draggable-horse .horse-label {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 5px;
      font-weight: bold;
    }
    .slot-container {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .battle-slot {
      width: 200px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }
    .slot-title {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 10px;
    }
    .slot-vs {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .drop-zone {
      width: 70px;
      height: 90px;
      border: 2px dashed rgba(74,222,128,0.5);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .drop-zone.drag-over {
      border-color: #4ade80;
      background: rgba(74,222,128,0.1);
    }
    .drop-zone.filled {
      border-style: solid;
      border-color: #4ade80;
      background: rgba(74,222,128,0.15);
    }
    .drop-zone .placeholder {
      color: rgba(255,255,255,0.3);
      font-size: 0.75rem;
    }
    .qi-horse-display {
      width: 70px;
      height: 90px;
      background: rgba(255,107,107,0.15);
      border: 2px solid rgba(255,107,107,0.5);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .vs-icon {
      font-size: 1.2rem;
      color: #ff6b6b;
      font-weight: bold;
    }
    
    /* èµ›é©¬åœº */
    .race-track {
      background: linear-gradient(180deg, #2d5016 0%, #1e3a0f 100%);
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      border: 4px solid #8b4513;
      position: relative;
      overflow: hidden;
    }
    .track-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 0 10px;
    }
    .track-header span {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
    }
    .race-lanes {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .race-lane {
      display: flex;
      align-items: center;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 10px 15px;
      position: relative;
    }
    .lane-label {
      width: 80px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
    }
    .horses-battle {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      position: relative;
    }
    .race-progress {
      position: absolute;
      top: 50%;
      left: 50px;
      right: 50px;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      transform: translateY(-50%);
    }
    .race-progress-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.1s linear;
    }
    .race-progress-bar.tian { background: #4ade80; }
    .race-progress-bar.qi { background: #ff6b6b; float: right; }
    .horse-entry {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      z-index: 1;
    }
    .horse-icon {
      font-size: 2.5rem;
      transition: transform 0.3s;
    }
    .horse-icon.racing {
      animation: horseRun 0.2s ease infinite;
    }
    .horse-icon.winner { animation: horseWin 0.5s ease infinite; }
    @keyframes horseRun {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      25% { transform: translateX(3px) rotate(2deg); }
      75% { transform: translateX(-3px) rotate(-2deg); }
    }
    @keyframes horseWin {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-8px) scale(1.1); }
    }
    .horse-grade {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: bold;
    }
    .grade-top { background: #ffd93d; color: #333; }
    .grade-mid { background: #c0c0c0; color: #333; }
    .grade-low { background: #cd7f32; color: #333; }
    .vs-text {
      font-size: 1.2rem;
      font-weight: bold;
      color: #ff6b6b;
      z-index: 1;
    }
    .result-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .result-win { background: #4ade80; color: #000; }
    .result-lose { background: #ff6b6b; color: #fff; }
    
    /* æ¯”åˆ†æ¿ */
    .scoreboard {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 20px 0;
    }
    .score-item { text-align: center; }
    .score-name { font-size: 1.1rem; margin-bottom: 5px; }
    .score-name.tian { color: #4ade80; }
    .score-name.qi { color: #ff6b6b; }
    .score-value { font-size: 3rem; font-weight: bold; }
    .score-value.tian { color: #4ade80; }
    .score-value.qi { color: #ff6b6b; }
    
    /* æŒ‰é’® */
    .game-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .game-btn {
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .game-btn.primary {
      background: linear-gradient(135deg, #ffd93d, #f0c000);
      color: #333;
    }
    .game-btn.secondary {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .game-btn.danger {
      background: linear-gradient(135deg, #ff6b6b, #e05555);
      color: white;
    }
    .game-btn:hover { transform: translateY(-2px); }
    .game-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    /* æˆ˜ç»©ç»Ÿè®¡ */
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    @media (max-width: 600px) {
      .stats-panel { grid-template-columns: repeat(2, 1fr); }
    }
    .stat-box {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }
    .stat-box .label {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.5);
      margin-bottom: 5px;
    }
    .stat-box .value {
      font-size: 1.8rem;
      font-weight: bold;
    }
    .stat-box .value.green { color: #4ade80; }
    .stat-box .value.red { color: #ff6b6b; }
    .stat-box .value.gold { color: #ffd93d; }
    
    /* é½ç‹AIè®¾ç½® */
    .ai-settings {
      background: rgba(255,107,107,0.1);
      border: 1px solid rgba(255,107,107,0.3);
      border-radius: 12px;
      padding: 15px;
      margin: 15px 0;
    }
    .ai-settings h4 {
      color: #ff6b6b;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }
    .ai-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .ai-option {
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      background: rgba(0,0,0,0.2);
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .ai-option:hover { border-color: #ff6b6b; }
    .ai-option.active {
      border-color: #ff6b6b;
      background: rgba(255,107,107,0.2);
      color: #ff6b6b;
    }
    
    /* å†å²è®°å½• */
    .history-section {
      margin-top: 20px;
    }
    .history-title {
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    .history-list {
      max-height: 200px;
      overflow-y: auto;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 10px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 0.85rem;
    }
    .history-item:last-child { border-bottom: none; }
    .history-item .round { color: rgba(255,255,255,0.4); }
    .history-item .strategy { color: rgba(255,255,255,0.7); }
    .history-item .result { font-weight: bold; }
    .history-item .result.win { color: #4ade80; }
    .history-item .result.lose { color: #ff6b6b; }
    
    /* åˆ†æåŒº */
    .analysis {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 22px;
      margin-top: 20px;
    }
    .analysis h3 {
      color: #ffd93d;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }
    .analysis p {
      color: rgba(255,255,255,0.85);
      line-height: 1.85;
      margin-bottom: 14px;
    }
    .analysis .formula {
      background: rgba(255,255,255,0.08);
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      margin: 14px 0;
      overflow-x: auto;
    }
    .analysis .highlight { color: #ff6b6b; font-weight: bold; }
    .analysis .safe { color: #4ade80; font-weight: bold; }
    
    /* æ’åˆ—ç»„åˆè¡¨ */
    .combo-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 0.9rem;
    }
    .combo-table th, .combo-table td {
      padding: 12px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .combo-table th {
      background: rgba(255,217,61,0.2);
      color: #ffd93d;
    }
    .combo-table tr:hover { background: rgba(255,255,255,0.05); }
    .combo-table tr.clickable { cursor: pointer; }
    .combo-table tr.clickable:hover { background: rgba(74,222,128,0.1); }
    .combo-table tr.selected { background: rgba(74,222,128,0.2); }
    
    /* ç»“è®º */
    .conclusion {
      background: linear-gradient(135deg, rgba(74,222,128,0.15), rgba(255,217,61,0.1));
      border: 2px solid #4ade80;
      border-radius: 16px;
      padding: 25px;
      text-align: center;
      margin-top: 20px;
    }
    .conclusion h3 {
      font-size: 1.4rem;
      margin-bottom: 15px;
      color: #4ade80;
    }
    .conclusion p {
      color: rgba(255,255,255,0.9);
      line-height: 1.85;
    }
    
    /* è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ */
    .sim-results {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    @media (max-width: 500px) {
      .sim-results { grid-template-columns: 1fr; }
    }
    .sim-card {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .sim-card h4 {
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
      margin-bottom: 10px;
    }
    .sim-card .big-num {
      font-size: 2.2rem;
      font-weight: bold;
    }
    .sim-card .big-num.green { color: #4ade80; }
    .sim-card .big-num.red { color: #ff6b6b; }
    .sim-card .big-num.gold { color: #ffd93d; }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 0.9rem;
      opacity: 0;
      transition: all 0.3s;
      z-index: 10000;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .toast.success { background: rgba(74,222,128,0.9); }
    .toast.error { background: rgba(255,107,107,0.9); }
  </style>
</head>
<body>
  <div class="container">
    <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
    <h1>ğŸ‡ ç”°å¿Œèµ›é©¬æ¨¡æ‹Ÿå™¨</h1>
    <p class="subtitle">è¿™æ˜¯ç ´åè§„åˆ™ï¼Œè¿˜æ˜¯åšå¼ˆæ™ºæ…§ï¼Ÿ</p>
    
    <div class="card">
      <div class="question-box">
        <strong>çŸ¥ä¹çƒ­è®®ï¼š</strong>æˆ‘è€å¸ˆè¯´ç”°å¿Œèµ›é©¬çš„èƒœåˆ©æ˜¯ä¸€ç§ç ´åè§„åˆ™çš„åšæ³•ã€‚<br>
        å¤§å®¶æŠŠå„è‡ªçš„é©¬åˆ†ä¸ºä¸‰ç­‰åˆ†åˆ«æ¯”èµ›ï¼Œç»“æœç”°å¿Œéšç’äº‹å®å–å·§è·èƒœï¼Ÿ<br>
        <strong>è¿™åˆ°åº•æ˜¯ä½œå¼Šï¼Œè¿˜æ˜¯æ™ºæ…§ï¼Ÿ</strong>
      </div>
      
      <!-- æ¨¡å¼åˆ‡æ¢ -->
      <div class="mode-tabs">
        <div class="mode-tab active" onclick="switchMode('classic')">
          <span class="icon">ğŸ“‹</span>
          ç»å…¸æ¨¡å¼
        </div>
        <div class="mode-tab" onclick="switchMode('drag')">
          <span class="icon">ğŸ¯</span>
          è‡ªç”±æ’å…µ
        </div>
        <div class="mode-tab" onclick="switchMode('ai')">
          <span class="icon">ğŸ¤–</span>
          æ™ºèƒ½é½ç‹
        </div>
      </div>
      
      <!-- æˆ˜ç»©ç»Ÿè®¡ -->
      <div class="stats-panel">
        <div class="stat-box">
          <div class="label">æ€»åœºæ¬¡</div>
          <div class="value gold" id="totalGames">0</div>
        </div>
        <div class="stat-box">
          <div class="label">ç”°å¿Œèƒœ</div>
          <div class="value green" id="tianWins">0</div>
        </div>
        <div class="stat-box">
          <div class="label">é½ç‹èƒœ</div>
          <div class="value red" id="qiWins">0</div>
        </div>
        <div class="stat-box">
          <div class="label">èƒœç‡</div>
          <div class="value gold" id="winRate">-</div>
        </div>
      </div>
      
      <!-- ç»å…¸æ¨¡å¼ -->
      <div id="classicMode">
        <div class="strategy-section">
          <h3 class="strategy-title">ğŸ¯ é€‰æ‹©ç”°å¿Œçš„å‡ºæˆ˜ç­–ç•¥</h3>
          <div class="strategy-options">
            <button class="strategy-btn" id="strategyNormal" onclick="selectStrategy('normal')">
              <h4>ğŸ“‹ å¸¸è§„å¯¹é˜µï¼ˆä¸Šå¯¹ä¸Šï¼‰</h4>
              <p>ä¸Šç­‰é©¬ vs ä¸Šç­‰é©¬<br>ä¸­ç­‰é©¬ vs ä¸­ç­‰é©¬<br>ä¸‹ç­‰é©¬ vs ä¸‹ç­‰é©¬</p>
            </button>
            <button class="strategy-btn active" id="strategySmart" onclick="selectStrategy('smart')">
              <h4>ğŸ§  å­™è†‘ç­–ç•¥ï¼ˆé”™ä½å¯¹é˜µï¼‰</h4>
              <p>ä¸‹ç­‰é©¬ vs ä¸Šç­‰é©¬<br>ä¸Šç­‰é©¬ vs ä¸­ç­‰é©¬<br>ä¸­ç­‰é©¬ vs ä¸‹ç­‰é©¬</p>
            </button>
          </div>
        </div>
      </div>
      
      <!-- è‡ªç”±æ’å…µæ¨¡å¼ -->
      <div id="dragMode" style="display: none;">
        <div class="drag-section">
          <h3 class="drag-title">ğŸ¯ æ‹–æ‹½ä½ çš„é©¬åŒ¹åˆ°å¯¹åº”ä½ç½®</h3>
          <p class="drag-hint">æŠŠç”°å¿Œçš„é©¬æ‹–åˆ°å·¦ä¾§ç©ºä½ï¼Œä¸é½ç‹çš„é©¬å¯¹é˜µ</p>
          
          <div class="horse-pool" id="horsePool">
            <div class="draggable-horse" draggable="true" data-grade="top">
              <span class="horse-emoji">ğŸ</span>
              <span class="horse-label grade-top">ä¸Šç­‰</span>
            </div>
            <div class="draggable-horse" draggable="true" data-grade="mid">
              <span class="horse-emoji">ğŸ</span>
              <span class="horse-label grade-mid">ä¸­ç­‰</span>
            </div>
            <div class="draggable-horse" draggable="true" data-grade="low">
              <span class="horse-emoji">ğŸ</span>
              <span class="horse-label grade-low">ä¸‹ç­‰</span>
            </div>
          </div>
          
          <div class="slot-container">
            <div class="battle-slot">
              <div class="slot-title">ç¬¬ä¸€åœº</div>
              <div class="slot-vs">
                <div class="drop-zone" data-slot="0">
                  <span class="placeholder">æ‹–åˆ°è¿™é‡Œ</span>
                </div>
                <span class="vs-icon">VS</span>
                <div class="qi-horse-display">
                  <span class="horse-emoji">ğŸ´</span>
                  <span class="horse-label grade-top">ä¸Šç­‰</span>
                </div>
              </div>
            </div>
            <div class="battle-slot">
              <div class="slot-title">ç¬¬äºŒåœº</div>
              <div class="slot-vs">
                <div class="drop-zone" data-slot="1">
                  <span class="placeholder">æ‹–åˆ°è¿™é‡Œ</span>
                </div>
                <span class="vs-icon">VS</span>
                <div class="qi-horse-display">
                  <span class="horse-emoji">ğŸ´</span>
                  <span class="horse-label grade-mid">ä¸­ç­‰</span>
                </div>
              </div>
            </div>
            <div class="battle-slot">
              <div class="slot-title">ç¬¬ä¸‰åœº</div>
              <div class="slot-vs">
                <div class="drop-zone" data-slot="2">
                  <span class="placeholder">æ‹–åˆ°è¿™é‡Œ</span>
                </div>
                <span class="vs-icon">VS</span>
                <div class="qi-horse-display">
                  <span class="horse-emoji">ğŸ´</span>
                  <span class="horse-label grade-low">ä¸‹ç­‰</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- æ™ºèƒ½é½ç‹æ¨¡å¼ -->
      <div id="aiMode" style="display: none;">
        <div class="ai-settings">
          <h4>ğŸ¤– é½ç‹AIéš¾åº¦</h4>
          <div class="ai-options">
            <div class="ai-option active" data-ai="dumb" onclick="setAI('dumb')">
              ğŸ˜´ å‚²æ…¢é½ç‹<br><small>å›ºå®šä¸Šä¸­ä¸‹</small>
            </div>
            <div class="ai-option" data-ai="random" onclick="setAI('random')">
              ğŸ² éšæœºé½ç‹<br><small>éšæœºå‡ºæˆ˜</small>
            </div>
            <div class="ai-option" data-ai="smart" onclick="setAI('smart')">
              ğŸ§  èªæ˜é½ç‹<br><small>ä¼šååˆ¶</small>
            </div>
            <div class="ai-option" data-ai="optimal" onclick="setAI('optimal')">
              ğŸ‘‘ æœ€ä¼˜é½ç‹<br><small>åšå¼ˆè®ºæœ€ä¼˜</small>
            </div>
          </div>
        </div>
        <div class="drag-section">
          <h3 class="drag-title">ğŸ¯ æ’å…µå¸ƒé˜µå¯¹æŠ—AI</h3>
          <div class="horse-pool" id="aiHorsePool">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </div>
          <div class="slot-container" id="aiSlots">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
      
      <!-- èµ›é©¬åœº -->
      <div class="race-track">
        <div class="track-header">
          <span>ğŸŸ¢ ç”°å¿Œ</span>
          <span>ğŸ”´ é½ç‹</span>
        </div>
        <div class="race-lanes" id="raceLanes">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      
      <!-- æ¯”åˆ†æ¿ -->
      <div class="scoreboard">
        <div class="score-item">
          <div class="score-name tian">ç”°å¿Œ</div>
          <div class="score-value tian" id="tianScore">0</div>
        </div>
        <div class="score-item">
          <div class="score-name" style="color: rgba(255,255,255,0.5);">:</div>
          <div class="score-value" style="color: rgba(255,255,255,0.3);">-</div>
        </div>
        <div class="score-item">
          <div class="score-name qi">é½ç‹</div>
          <div class="score-value qi" id="qiScore">0</div>
        </div>
      </div>
      
      <div class="game-buttons">
        <button class="game-btn primary" id="raceBtn" onclick="startRace()">ğŸ å¼€å§‹æ¯”èµ›</button>
        <button class="game-btn secondary" onclick="resetRace()">ğŸ”„ é‡ç½®</button>
        <button class="game-btn secondary" onclick="clearStats()">ğŸ—‘ï¸ æ¸…é™¤æˆ˜ç»©</button>
      </div>
      
      <!-- å†å²è®°å½• -->
      <div class="history-section">
        <h4 class="history-title">ğŸ“œ æ¯”èµ›è®°å½•</h4>
        <div class="history-list" id="historyList">
          <div style="color: rgba(255,255,255,0.4); text-align: center; padding: 20px;">æš‚æ— è®°å½•</div>
        </div>
      </div>
    </div>
    
    <!-- æ‰€æœ‰æ’åˆ—ç»„åˆ -->
    <div class="card">
      <h2 style="margin-bottom: 15px; color: #ffd93d;">ğŸ“Š ç©·ä¸¾æ‰€æœ‰å¯èƒ½ï¼š6ç§æ’åˆ—ç»„åˆ</h2>
      <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">
        ç”°å¿Œçš„ä¸‰åŒ¹é©¬æœ‰ 3! = 6 ç§å‡ºæˆ˜é¡ºåºï¼Œç‚¹å‡»ä»»æ„ä¸€è¡Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ç­–ç•¥ï¼š
      </p>
      
      <table class="combo-table" id="comboTable">
        <thead>
          <tr>
            <th>ç­–ç•¥</th>
            <th>ç¬¬ä¸€åœº</th>
            <th>ç¬¬äºŒåœº</th>
            <th>ç¬¬ä¸‰åœº</th>
            <th>ç»“æœ</th>
          </tr>
        </thead>
        <tbody>
          <tr class="clickable" onclick="useStrategy(['top','mid','low'])">
            <td>ä¸Š-ä¸­-ä¸‹</td>
            <td>ä¸Švsä¸Š âŒ</td>
            <td>ä¸­vsä¸­ âŒ</td>
            <td>ä¸‹vsä¸‹ âŒ</td>
            <td style="color: #ff6b6b;">0:3 æƒ¨è´¥</td>
          </tr>
          <tr class="clickable" onclick="useStrategy(['top','low','mid'])">
            <td>ä¸Š-ä¸‹-ä¸­</td>
            <td>ä¸Švsä¸Š âŒ</td>
            <td>ä¸‹vsä¸­ âŒ</td>
            <td>ä¸­vsä¸‹ âœ…</td>
            <td style="color: #ff6b6b;">1:2 è¾“</td>
          </tr>
          <tr class="clickable" onclick="useStrategy(['mid','top','low'])">
            <td>ä¸­-ä¸Š-ä¸‹</td>
            <td>ä¸­vsä¸Š âŒ</td>
            <td>ä¸Švsä¸­ âœ…</td>
            <td>ä¸‹vsä¸‹ âŒ</td>
            <td style="color: #ff6b6b;">1:2 è¾“</td>
          </tr>
          <tr class="clickable" onclick="useStrategy(['mid','low','top'])">
            <td>ä¸­-ä¸‹-ä¸Š</td>
            <td>ä¸­vsä¸Š âŒ</td>
            <td>ä¸‹vsä¸­ âŒ</td>
            <td>ä¸Švsä¸‹ âœ…</td>
            <td style="color: #ff6b6b;">1:2 è¾“</td>
          </tr>
          <tr class="clickable" onclick="useStrategy(['low','top','mid'])">
            <td>ä¸‹-ä¸Š-ä¸­</td>
            <td>ä¸‹vsä¸Š âŒ</td>
            <td>ä¸Švsä¸­ âœ…</td>
            <td>ä¸­vsä¸‹ âœ…</td>
            <td style="color: #4ade80;">2:1 èµ¢ï¼</td>
          </tr>
          <tr class="clickable" onclick="useStrategy(['low','mid','top'])">
            <td>ä¸‹-ä¸­-ä¸Š</td>
            <td>ä¸‹vsä¸Š âŒ</td>
            <td>ä¸­vsä¸­ âŒ</td>
            <td>ä¸Švsä¸‹ âœ…</td>
            <td style="color: #ff6b6b;">1:2 è¾“</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ -->
    <div class="card">
      <h2 style="margin-bottom: 15px; color: #ffd93d;">ğŸ² è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ</h2>
      <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">
        å¦‚æœåŒæ–¹éƒ½éšæœºå‡ºæˆ˜ï¼Œæˆ–è€…ä¸€æ–¹ä½¿ç”¨æœ€ä¼˜ç­–ç•¥ï¼Œç»“æœä¼šæ€æ ·ï¼Ÿ
      </p>
      
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="game-btn primary" onclick="runSimulation('random')">ğŸ² åŒæ–¹éšæœº</button>
        <button class="game-btn secondary" onclick="runSimulation('tianSmart')">ğŸ§  ç”°å¿Œæœ€ä¼˜</button>
        <button class="game-btn danger" onclick="runSimulation('qiSmart')">ğŸ‘‘ é½ç‹æœ€ä¼˜</button>
      </div>
      
      <div class="sim-results" id="simResults" style="display: none;">
        <div class="sim-card">
          <h4>ğŸ† ç”°å¿Œè·èƒœ</h4>
          <div class="big-num green" id="simWin">-</div>
        </div>
        <div class="sim-card">
          <h4>ğŸ’€ é½ç‹è·èƒœ</h4>
          <div class="big-num red" id="simLose">-</div>
        </div>
        <div class="sim-card">
          <h4>ğŸ“Š ç”°å¿Œèƒœç‡</h4>
          <div class="big-num gold" id="simRate">-</div>
        </div>
        <div class="sim-card">
          <h4>ğŸ“ˆ æ¨¡æ‹Ÿåœºæ™¯</h4>
          <div class="big-num" style="font-size: 1rem; color: rgba(255,255,255,0.7);" id="simScenario">-</div>
        </div>
      </div>
    </div>
    
    <!-- æ ¸å¿ƒåˆ†æ -->
    <div class="card analysis">
      <h3>ğŸ¤” è¿™æ˜¯ç ´åè§„åˆ™å—ï¼Ÿè®©æˆ‘ä»¬é€æ¡åˆ†æ</h3>
      
      <p><strong>1. è§„åˆ™åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
      <p>
        åŸæ–‡è®°è½½çš„è§„åˆ™æ˜¯ï¼š<span class="highlight">ã€Œä»¥åƒé‡‘ä¸ºæ³¨ï¼Œä¸‰å±€ä¸¤èƒœã€</span>ã€‚<br>
        è§„åˆ™åªè§„å®šäº†ï¼šâ‘  å„å‡ºä¸‰åŒ¹é©¬ â‘¡ æ¯”ä¸‰åœº â‘¢ èµ¢ä¸¤åœºç®—èµ¢ã€‚<br>
        <span class="safe">è§„åˆ™ä»æœªè§„å®šã€Œå¿…é¡»æŒ‰ç­‰çº§å¯¹åº”å‡ºæˆ˜ã€</span>ã€‚
      </p>
      
      <p><strong>2. é½ç‹ä¸ºä»€ä¹ˆæŒ‰ç­‰çº§å‡ºæˆ˜ï¼Ÿ</strong></p>
      <p>
        å› ä¸ºé½ç‹çš„é©¬<span class="highlight">æ¯ä¸ªç­‰çº§éƒ½æ¯”ç”°å¿Œå¼º</span>ï¼ŒæŒ‰ç­‰çº§å¯¹é˜µä»–ç¨³èµ¢3:0ã€‚<br>
        è¿™ä¸æ˜¯ã€Œè§„åˆ™ã€ï¼Œè€Œæ˜¯é½ç‹çš„<span class="highlight">æœ€ä¼˜ç­–ç•¥</span>â€”â€”åœ¨ä»–çœ‹æ¥æ²¡å¿…è¦å˜ã€‚
      </p>
      
      <p><strong>3. ç”°å¿Œåšäº†ä»€ä¹ˆï¼Ÿ</strong></p>
      <p>
        ç”°å¿Œåªæ˜¯<span class="safe">æ”¹å˜äº†è‡ªå·±çš„å‡ºæˆ˜é¡ºåº</span>ï¼Œè¿™å®Œå…¨åœ¨è§„åˆ™å…è®¸èŒƒå›´å†…ã€‚<br>
        ä»–æ²¡æœ‰ï¼šæ¢é©¬ã€ä½œå¼Šã€è´¿èµ‚è£åˆ¤ã€ç»™é©¬åƒå…´å¥‹å‰‚â€¦â€¦
      </p>
      
      <div class="formula">
        ç±»æ¯”ï¼šä¸‹æ£‹æ—¶ï¼Œä½ çš„è½¦æ¯”æˆ‘å¼ºï¼Œæˆ‘å°±ä¸èƒ½ç”¨é©¬å»åƒä½ çš„è½¦å—ï¼Ÿ<br>
        è¶³çƒæ¯”èµ›ï¼Œå¯¹æ–¹å‰é”‹å‰å®³ï¼Œæˆ‘å°±ä¸èƒ½æ´¾åå«ç›¯é˜²å—ï¼Ÿ
      </div>
      
      <p><strong>4. åšå¼ˆè®ºè§†è§’</strong></p>
      <p>
        è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„<span class="highlight">ã€Œä¿¡æ¯ä¸å¯¹ç§°åšå¼ˆã€</span>ï¼š<br>
        é½ç‹å‡è®¾ç”°å¿Œä¼šæŒ‰å¸¸è§„å‡ºæˆ˜ï¼ˆå› ä¸ºä»–è‡ªå¤§ï¼‰ï¼Œç”°å¿Œåˆ©ç”¨äº†è¿™ä¸ªå‡è®¾ã€‚<br>
        å¦‚æœé½ç‹ä¹Ÿæ”¹å˜ç­–ç•¥å‘¢ï¼Ÿé‚£å°±å˜æˆäº†ã€ŒçŒœæ‹³ã€â€”â€”ä½†é½ç‹çš„å‚²æ…¢è®©ä»–æ²¡è¿™ä¹ˆåšã€‚
      </p>
    </div>
    
    <!-- ç»“è®º -->
    <div class="card conclusion">
      <h3>ğŸ’¡ ç»“è®ºï¼šè¿™ä¸æ˜¯ç ´åè§„åˆ™ï¼Œæ˜¯åšå¼ˆæ™ºæ…§</h3>
      <p>
        ç”°å¿Œèµ›é©¬çš„ç²¾é«“åœ¨äºï¼š<br><br>
        <strong>åœ¨è§„åˆ™å…è®¸çš„èŒƒå›´å†…ï¼Œæ‰¾åˆ°æœ€ä¼˜è§£ã€‚</strong><br><br>
        é½ç‹è¾“åœ¨å‚²æ…¢â€”â€”ä»–ä»¥ä¸ºè‡ªå·±ç¨³èµ¢ï¼Œæ‰€ä»¥æ²¡æœ‰æ€è€ƒå¯¹ç­–ã€‚<br>
        ç”°å¿Œèµ¢åœ¨æ™ºæ…§â€”â€”ä»–åœ¨åŠ£åŠ¿ä¸­æ‰¾åˆ°äº†å”¯ä¸€çš„è·èƒœè·¯å¾„ã€‚<br><br>
        <span style="color: #ffd93d;">è¿™ä¸ªæ•…äº‹æ•™æˆ‘ä»¬çš„ä¸æ˜¯ã€Œå¦‚ä½•ä½œå¼Šã€ï¼Œ<br>
        è€Œæ˜¯ã€Œå¦‚ä½•åœ¨ä¸åˆ©æ¡ä»¶ä¸‹ï¼Œé€šè¿‡ç­–ç•¥é€†è½¬å±€é¢ã€ã€‚</span>
      </p>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>


  <script>
    // é©¬åŒ¹æ•°æ®
    const horses = {
      qi: { top: 100, mid: 90, low: 80 },
      tian: { top: 95, mid: 85, low: 75 }
    };
    
    // æ¸¸æˆçŠ¶æ€
    let currentMode = 'classic';
    let currentStrategy = 'smart';
    let currentAI = 'dumb';
    let raceInProgress = false;
    let draggedHorse = null;
    let customTianOrder = [null, null, null];
    let customQiOrder = ['top', 'mid', 'low'];
    
    // ç»Ÿè®¡æ•°æ®
    let stats = {
      total: 0,
      tianWins: 0,
      qiWins: 0,
      history: []
    };
    
    // ä»localStorageåŠ è½½ç»Ÿè®¡
    function loadStats() {
      const saved = localStorage.getItem('tianji-stats');
      if (saved) {
        stats = JSON.parse(saved);
        updateStatsDisplay();
        renderHistory();
      }
    }
    
    function saveStats() {
      localStorage.setItem('tianji-stats', JSON.stringify(stats));
    }
    
    function updateStatsDisplay() {
      document.getElementById('totalGames').textContent = stats.total;
      document.getElementById('tianWins').textContent = stats.tianWins;
      document.getElementById('qiWins').textContent = stats.qiWins;
      document.getElementById('winRate').textContent = stats.total > 0 
        ? (stats.tianWins / stats.total * 100).toFixed(1) + '%' 
        : '-';
    }
    
    function clearStats() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æˆ˜ç»©å—ï¼Ÿ')) {
        stats = { total: 0, tianWins: 0, qiWins: 0, history: [] };
        saveStats();
        updateStatsDisplay();
        renderHistory();
        showToast('æˆ˜ç»©å·²æ¸…é™¤', 'success');
      }
    }
    
    // ç­–ç•¥å®šä¹‰
    const strategies = {
      normal: ['top', 'mid', 'low'],
      smart: ['low', 'top', 'mid']
    };
    
    const allStrategies = [
      ['top', 'mid', 'low'],
      ['top', 'low', 'mid'],
      ['mid', 'top', 'low'],
      ['mid', 'low', 'top'],
      ['low', 'top', 'mid'],
      ['low', 'mid', 'top']
    ];
    
    // æ¨¡å¼åˆ‡æ¢
    function switchMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.mode-tab[onclick="switchMode('${mode}')"]`).classList.add('active');
      
      document.getElementById('classicMode').style.display = mode === 'classic' ? 'block' : 'none';
      document.getElementById('dragMode').style.display = mode === 'drag' ? 'block' : 'none';
      document.getElementById('aiMode').style.display = mode === 'ai' ? 'block' : 'none';
      
      if (mode === 'drag') {
        initDragMode();
      } else if (mode === 'ai') {
        initAIMode();
      }
      
      resetRace();
    }
    
    // ç»å…¸æ¨¡å¼
    function selectStrategy(strategy) {
      currentStrategy = strategy;
      document.querySelectorAll('.strategy-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(strategy === 'normal' ? 'strategyNormal' : 'strategySmart').classList.add('active');
      resetRace();
    }
    
    function useStrategy(order) {
      customTianOrder = [...order];
      switchMode('drag');
      
      // å¡«å……æ‹–æ‹½æ§½ä½
      setTimeout(() => {
        const dropZones = document.querySelectorAll('#dragMode .drop-zone');
        dropZones.forEach((zone, i) => {
          const grade = order[i];
          zone.innerHTML = `
            <span class="horse-emoji">ğŸ</span>
            <span class="horse-label ${getGradeClass(grade)}">${getGradeLabel(grade)}</span>
          `;
          zone.classList.add('filled');
          zone.dataset.horse = grade;
        });
        
        // éšè—å·²ä½¿ç”¨çš„é©¬
        document.querySelectorAll('#horsePool .draggable-horse').forEach(horse => {
          horse.style.display = 'none';
        });
        
        showToast('å·²åº”ç”¨ç­–ç•¥ï¼Œç‚¹å‡»å¼€å§‹æ¯”èµ›', 'success');
      }, 100);
    }
    
    // æ‹–æ‹½æ¨¡å¼
    function initDragMode() {
      customTianOrder = [null, null, null];
      
      const pool = document.getElementById('horsePool');
      pool.innerHTML = `
        <div class="draggable-horse" draggable="true" data-grade="top">
          <span class="horse-emoji">ğŸ</span>
          <span class="horse-label grade-top">ä¸Šç­‰</span>
        </div>
        <div class="draggable-horse" draggable="true" data-grade="mid">
          <span class="horse-emoji">ğŸ</span>
          <span class="horse-label grade-mid">ä¸­ç­‰</span>
        </div>
        <div class="draggable-horse" draggable="true" data-grade="low">
          <span class="horse-emoji">ğŸ</span>
          <span class="horse-label grade-low">ä¸‹ç­‰</span>
        </div>
      `;
      
      // é‡ç½®drop zones
      document.querySelectorAll('#dragMode .drop-zone').forEach(zone => {
        zone.innerHTML = '<span class="placeholder">æ‹–åˆ°è¿™é‡Œ</span>';
        zone.classList.remove('filled');
        delete zone.dataset.horse;
      });
      
      setupDragListeners();
    }
    
    function setupDragListeners() {
      document.querySelectorAll('.draggable-horse').forEach(horse => {
        horse.addEventListener('dragstart', handleDragStart);
        horse.addEventListener('dragend', handleDragEnd);
      });
      
      document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('dragleave', handleDragLeave);
        zone.addEventListener('drop', handleDrop);
      });
    }
    
    function handleDragStart(e) {
      draggedHorse = e.target;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedHorse = null;
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      const zone = e.currentTarget;
      zone.classList.remove('drag-over');
      
      if (!draggedHorse) return;
      
      const grade = draggedHorse.dataset.grade;
      const slot = parseInt(zone.dataset.slot);
      
      // å¦‚æœæ§½ä½å·²æœ‰é©¬ï¼Œå…ˆæ”¾å›
      if (zone.dataset.horse) {
        const oldGrade = zone.dataset.horse;
        returnHorseToPool(oldGrade);
      }
      
      // æ”¾å…¥æ–°é©¬
      zone.innerHTML = `
        <span class="horse-emoji">ğŸ</span>
        <span class="horse-label ${getGradeClass(grade)}">${getGradeLabel(grade)}</span>
      `;
      zone.classList.add('filled');
      zone.dataset.horse = grade;
      customTianOrder[slot] = grade;
      
      // éšè—å·²ä½¿ç”¨çš„é©¬
      draggedHorse.style.display = 'none';
      
      // ç‚¹å‡»å·²æ”¾ç½®çš„é©¬å¯ä»¥å–å›
      zone.onclick = () => {
        if (zone.dataset.horse) {
          returnHorseToPool(zone.dataset.horse);
          zone.innerHTML = '<span class="placeholder">æ‹–åˆ°è¿™é‡Œ</span>';
          zone.classList.remove('filled');
          customTianOrder[slot] = null;
          delete zone.dataset.horse;
          zone.onclick = null;
        }
      };
    }
    
    function returnHorseToPool(grade) {
      const pool = document.getElementById('horsePool') || document.getElementById('aiHorsePool');
      const horse = pool.querySelector(`[data-grade="${grade}"]`);
      if (horse) horse.style.display = 'flex';
    }
    
    // AIæ¨¡å¼
    function initAIMode() {
      customTianOrder = [null, null, null];
      
      const pool = document.getElementById('aiHorsePool');
      pool.innerHTML = `
        <div class="draggable-horse" draggable="true" data-grade="top">
          <span class="horse-emoji">ğŸ</span>
          <span class="horse-label grade-top">ä¸Šç­‰</span>
        </div>
        <div class="draggable-horse" draggable="true" data-grade="mid">
          <span class="horse-emoji">ğŸ</span>
          <span class="horse-label grade-mid">ä¸­ç­‰</span>
        </div>
        <div class="draggable-horse" draggable="true" data-grade="low">
          <span class="horse-emoji">ğŸ</span>
          <span class="horse-label grade-low">ä¸‹ç­‰</span>
        </div>
      `;
      
      const slots = document.getElementById('aiSlots');
      slots.innerHTML = `
        <div class="battle-slot">
          <div class="slot-title">ç¬¬ä¸€åœº</div>
          <div class="slot-vs">
            <div class="drop-zone" data-slot="0"><span class="placeholder">æ‹–åˆ°è¿™é‡Œ</span></div>
            <span class="vs-icon">VS</span>
            <div class="qi-horse-display"><span class="horse-emoji">ğŸ´</span><span class="horse-label">?</span></div>
          </div>
        </div>
        <div class="battle-slot">
          <div class="slot-title">ç¬¬äºŒåœº</div>
          <div class="slot-vs">
            <div class="drop-zone" data-slot="1"><span class="placeholder">æ‹–åˆ°è¿™é‡Œ</span></div>
            <span class="vs-icon">VS</span>
            <div class="qi-horse-display"><span class="horse-emoji">ğŸ´</span><span class="horse-label">?</span></div>
          </div>
        </div>
        <div class="battle-slot">
          <div class="slot-title">ç¬¬ä¸‰åœº</div>
          <div class="slot-vs">
            <div class="drop-zone" data-slot="2"><span class="placeholder">æ‹–åˆ°è¿™é‡Œ</span></div>
            <span class="vs-icon">VS</span>
            <div class="qi-horse-display"><span class="horse-emoji">ğŸ´</span><span class="horse-label">?</span></div>
          </div>
        </div>
      `;
      
      setupDragListeners();
    }
    
    function setAI(ai) {
      currentAI = ai;
      document.querySelectorAll('.ai-option').forEach(opt => opt.classList.remove('active'));
      document.querySelector(`[data-ai="${ai}"]`).classList.add('active');
    }
    
    function getAIStrategy(tianOrder) {
      switch (currentAI) {
        case 'dumb':
          return ['top', 'mid', 'low'];
        case 'random':
          return allStrategies[Math.floor(Math.random() * 6)];
        case 'smart':
          // ç®€å•ååˆ¶ï¼šå¦‚æœçŸ¥é“ç”°å¿Œçš„ç­–ç•¥ï¼Œé€‰æ‹©èƒ½èµ¢çš„
          return findCounterStrategy(tianOrder);
        case 'optimal':
          // æ··åˆç­–ç•¥çº³ä»€å‡è¡¡
          return getOptimalMixedStrategy();
        default:
          return ['top', 'mid', 'low'];
      }
    }
    
    function findCounterStrategy(tianOrder) {
      // é½ç‹çš„é©¬æ›´å¼ºï¼Œæ‰¾ä¸€ä¸ªèƒ½èµ¢çš„ç­–ç•¥
      let bestStrategy = ['top', 'mid', 'low'];
      let bestScore = -3;
      
      for (const qiOrder of allStrategies) {
        let score = 0;
        for (let i = 0; i < 3; i++) {
          const qiPower = horses.qi[qiOrder[i]];
          const tianPower = horses.tian[tianOrder[i]];
          if (qiPower > tianPower) score++;
          else score--;
        }
        if (score > bestScore) {
          bestScore = score;
          bestStrategy = qiOrder;
        }
      }
      return bestStrategy;
    }
    
    function getOptimalMixedStrategy() {
      // çº³ä»€å‡è¡¡æ··åˆç­–ç•¥ï¼ˆç®€åŒ–ç‰ˆï¼‰
      const weights = [0.2, 0.15, 0.15, 0.15, 0.2, 0.15];
      const r = Math.random();
      let cumulative = 0;
      for (let i = 0; i < weights.length; i++) {
        cumulative += weights[i];
        if (r < cumulative) return allStrategies[i];
      }
      return allStrategies[0];
    }
    
    // å·¥å…·å‡½æ•°
    function getGradeLabel(grade) {
      return { top: 'ä¸Šç­‰', mid: 'ä¸­ç­‰', low: 'ä¸‹ç­‰' }[grade];
    }
    
    function getGradeClass(grade) {
      return { top: 'grade-top', mid: 'grade-mid', low: 'grade-low' }[grade];
    }
    
    function getStrategyName(order) {
      const names = { top: 'ä¸Š', mid: 'ä¸­', low: 'ä¸‹' };
      return order.map(g => names[g]).join('-');
    }
    
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    
    // æ¸²æŸ“èµ›é“
    function renderRaceLanes(tianOrder, qiOrder) {
      const lanes = document.getElementById('raceLanes');
      lanes.innerHTML = '';
      
      for (let i = 0; i < 3; i++) {
        const tianGrade = tianOrder[i];
        const qiGrade = qiOrder[i];
        
        const lane = document.createElement('div');
        lane.className = 'race-lane';
        lane.id = `lane${i}`;
        lane.innerHTML = `
          <div class="lane-label">ç¬¬${i + 1}åœº</div>
          <div class="horses-battle">
            <div class="horse-entry">
              <div class="horse-icon" id="tianHorse${i}">ğŸ</div>
              <span class="horse-grade ${getGradeClass(tianGrade)}">${getGradeLabel(tianGrade)}</span>
            </div>
            <div class="race-progress">
              <div class="race-progress-bar tian" id="tianProgress${i}" style="width: 0%"></div>
              <div class="race-progress-bar qi" id="qiProgress${i}" style="width: 0%"></div>
            </div>
            <div class="vs-text">VS</div>
            <div class="horse-entry">
              <div class="horse-icon" id="qiHorse${i}">ğŸ´</div>
              <span class="horse-grade ${getGradeClass(qiGrade)}">${getGradeLabel(qiGrade)}</span>
            </div>
          </div>
          <div class="result-badge" id="result${i}" style="visibility: hidden;">-</div>
        `;
        lanes.appendChild(lane);
      }
    }
    
    // è·å–å½“å‰å‡ºæˆ˜é¡ºåº
    function getCurrentOrders() {
      let tianOrder, qiOrder;
      
      if (currentMode === 'classic') {
        tianOrder = strategies[currentStrategy];
        qiOrder = ['top', 'mid', 'low'];
      } else if (currentMode === 'drag') {
        if (customTianOrder.includes(null)) {
          showToast('è¯·å…ˆå®Œæˆæ’å…µå¸ƒé˜µï¼', 'error');
          return null;
        }
        tianOrder = customTianOrder;
        qiOrder = ['top', 'mid', 'low'];
      } else if (currentMode === 'ai') {
        if (customTianOrder.includes(null)) {
          showToast('è¯·å…ˆå®Œæˆæ’å…µå¸ƒé˜µï¼', 'error');
          return null;
        }
        tianOrder = customTianOrder;
        qiOrder = getAIStrategy(tianOrder);
      } else {
        tianOrder = strategies[currentStrategy];
        qiOrder = ['top', 'mid', 'low'];
      }
      
      return { tianOrder, qiOrder };
    }
    
    // å¼€å§‹æ¯”èµ›
    async function startRace() {
      if (raceInProgress) return;
      
      const orders = getCurrentOrders();
      if (!orders) return;
      
      const { tianOrder, qiOrder } = orders;
      
      raceInProgress = true;
      document.getElementById('raceBtn').disabled = true;
      
      renderRaceLanes(tianOrder, qiOrder);
      
      let tianScore = 0;
      let qiScore = 0;
      
      for (let i = 0; i < 3; i++) {
        const tianGrade = tianOrder[i];
        const qiGrade = qiOrder[i];
        const tianPower = horses.tian[tianGrade];
        const qiPower = horses.qi[qiGrade];
        
        const tianHorse = document.getElementById(`tianHorse${i}`);
        const qiHorse = document.getElementById(`qiHorse${i}`);
        const tianProgress = document.getElementById(`tianProgress${i}`);
        const qiProgress = document.getElementById(`qiProgress${i}`);
        
        // èµ›è·‘åŠ¨ç”»
        tianHorse.classList.add('racing');
        qiHorse.classList.add('racing');
        
        const totalTime = 1000;
        const steps = 20;
        const stepTime = totalTime / steps;
        
        for (let step = 1; step <= steps; step++) {
          await new Promise(resolve => setTimeout(resolve, stepTime));
          const tianPercent = (tianPower / (tianPower + qiPower)) * (step / steps) * 100;
          const qiPercent = (qiPower / (tianPower + qiPower)) * (step / steps) * 100;
          tianProgress.style.width = tianPercent + '%';
          qiProgress.style.width = qiPercent + '%';
        }
        
        tianHorse.classList.remove('racing');
        qiHorse.classList.remove('racing');
        
        // åˆ¤æ–­èƒœè´Ÿ
        const resultBadge = document.getElementById(`result${i}`);
        resultBadge.style.visibility = 'visible';
        
        if (tianPower > qiPower) {
          tianScore++;
          resultBadge.textContent = 'ç”°å¿Œèƒœ';
          resultBadge.className = 'result-badge result-win';
          tianHorse.classList.add('winner');
        } else {
          qiScore++;
          resultBadge.textContent = 'é½ç‹èƒœ';
          resultBadge.className = 'result-badge result-lose';
          qiHorse.classList.add('winner');
        }
        
        document.getElementById('tianScore').textContent = tianScore;
        document.getElementById('qiScore').textContent = qiScore;
        
        await new Promise(resolve => setTimeout(resolve, 300));
      }
      
      // è®°å½•ç»“æœ
      const tianWon = tianScore > qiScore;
      stats.total++;
      if (tianWon) stats.tianWins++;
      else stats.qiWins++;
      
      stats.history.unshift({
        round: stats.total,
        tianStrategy: getStrategyName(tianOrder),
        qiStrategy: getStrategyName(qiOrder),
        result: tianWon ? 'win' : 'lose',
        score: `${tianScore}:${qiScore}`
      });
      
      if (stats.history.length > 20) stats.history.pop();
      
      saveStats();
      updateStatsDisplay();
      renderHistory();
      
      // æ˜¾ç¤ºç»“æœ
      if (tianWon) {
        showToast('ğŸ‰ ç”°å¿Œè·èƒœï¼', 'success');
      } else {
        showToast('ğŸ’€ é½ç‹è·èƒœ', 'error');
      }
      
      raceInProgress = false;
      document.getElementById('raceBtn').disabled = false;
    }
    
    function resetRace() {
      document.getElementById('tianScore').textContent = '0';
      document.getElementById('qiScore').textContent = '0';
      
      const orders = getCurrentOrders();
      if (orders) {
        renderRaceLanes(orders.tianOrder, orders.qiOrder);
      } else if (currentMode === 'classic') {
        renderRaceLanes(strategies[currentStrategy], ['top', 'mid', 'low']);
      }
    }
    
    function renderHistory() {
      const list = document.getElementById('historyList');
      if (stats.history.length === 0) {
        list.innerHTML = '<div style="color: rgba(255,255,255,0.4); text-align: center; padding: 20px;">æš‚æ— è®°å½•</div>';
        return;
      }
      
      list.innerHTML = stats.history.map(h => `
        <div class="history-item">
          <span class="round">#${h.round}</span>
          <span class="strategy">ç”°å¿Œ[${h.tianStrategy}] vs é½ç‹[${h.qiStrategy}]</span>
          <span class="result ${h.result}">${h.score} ${h.result === 'win' ? 'èƒœ' : 'è´Ÿ'}</span>
        </div>
      `).join('');
    }
    
    // è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ
    function runSimulation(scenario) {
      const simCount = 10000;
      let tianWins = 0;
      
      for (let i = 0; i < simCount; i++) {
        let tianOrder, qiOrder;
        
        if (scenario === 'random') {
          tianOrder = allStrategies[Math.floor(Math.random() * 6)];
          qiOrder = allStrategies[Math.floor(Math.random() * 6)];
        } else if (scenario === 'tianSmart') {
          tianOrder = ['low', 'top', 'mid']; // å­™è†‘ç­–ç•¥
          qiOrder = allStrategies[Math.floor(Math.random() * 6)];
        } else if (scenario === 'qiSmart') {
          tianOrder = allStrategies[Math.floor(Math.random() * 6)];
          qiOrder = findCounterStrategy(tianOrder);
        }
        
        let tianScore = 0;
        for (let j = 0; j < 3; j++) {
          if (horses.tian[tianOrder[j]] > horses.qi[qiOrder[j]]) {
            tianScore++;
          }
        }
        if (tianScore >= 2) tianWins++;
      }
      
      const scenarioNames = {
        random: 'åŒæ–¹éšæœºå‡ºæˆ˜',
        tianSmart: 'ç”°å¿Œç”¨å­™è†‘ç­–ç•¥ï¼Œé½ç‹éšæœº',
        qiSmart: 'ç”°å¿Œéšæœºï¼Œé½ç‹ååˆ¶'
      };
      
      document.getElementById('simResults').style.display = 'grid';
      document.getElementById('simWin').textContent = tianWins.toLocaleString();
      document.getElementById('simLose').textContent = (simCount - tianWins).toLocaleString();
      document.getElementById('simRate').textContent = (tianWins / simCount * 100).toFixed(1) + '%';
      document.getElementById('simScenario').textContent = scenarioNames[scenario];
    }
    
    // åˆå§‹åŒ–
    loadStats();
    renderRaceLanes(strategies.smart, ['top', 'mid', 'low']);
  </script>
</body>
</html>