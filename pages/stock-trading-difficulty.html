<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‚’è‚¡åˆ°åº•éš¾åœ¨å“ªï¼Ÿ</title>
  <script src="../components/header.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      padding: 20px;
      color: #e0e0e0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px 20px;
    }

    .header h1 {
      font-size: 2.5em;
      background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmer 3s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes shimmer {
      to { background-position: 200% center; }
    }

    .header p {
      font-size: 1.1em;
      color: #b0b0b0;
      line-height: 1.6;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card h2 {
      color: #ffd700;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .simulator {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .simulator {
        grid-template-columns: 1fr;
      }
    }

    .control-panel {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px;
      border-radius: 10px;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      margin-bottom: 8px;
      color: #ffd700;
      font-weight: 500;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffd700;
      cursor: pointer;
    }

    .value-display {
      color: #fff;
      font-size: 1.1em;
      margin-top: 5px;
    }

    button {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      color: #1a1a2e;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
      width: 100%;
      margin-top: 10px;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    .chart-container {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px;
      border-radius: 10px;
      height: 400px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-box {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-label {
      color: #b0b0b0;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .stat-value {
      color: #ffd700;
      font-size: 1.5em;
      font-weight: bold;
    }

    .stat-value.negative {
      color: #ff4444;
    }

    .stat-value.positive {
      color: #44ff44;
    }

    .insight {
      background: rgba(255, 215, 0, 0.1);
      border-left: 4px solid #ffd700;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
    }

    .insight-title {
      color: #ffd700;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .insight-text {
      color: #e0e0e0;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‰ ç‚’è‚¡åˆ°åº•éš¾åœ¨å“ªï¼Ÿ</h1>
      <p>ä¸€ä¸ªäº¤äº’å¼æ¨¡æ‹Ÿå™¨ï¼Œè®©ä½ äº²èº«ä½“éªŒè‚¡å¸‚çš„æ®‹é…·çœŸç›¸</p>
    </div>

    <div class="card">
      <h2>éš¾ç‚¹ä¸€ï¼šæ¦‚ç‡é™·é˜± - èƒœç‡â‰ èµšé’±</h2>
      <div class="simulator">
        <div class="control-panel">
          <div class="control-group">
            <label>èƒœç‡ï¼ˆèµ¢çš„æ¦‚ç‡ï¼‰</label>
            <input type="range" id="winRate" min="30" max="70" value="60" step="1">
            <div class="value-display"><span id="winRateValue">60</span>%</div>
          </div>

          <div class="control-group">
            <label>ç›ˆäºæ¯”ï¼ˆèµš/äºï¼‰</label>
            <input type="range" id="profitLossRatio" min="0.5" max="3" value="1" step="0.1">
            <div class="value-display"><span id="ratioValue">1.0</span>:1</div>
          </div>

          <div class="control-group">
            <label>æ¯æ¬¡æŠ•å…¥æœ¬é‡‘æ¯”ä¾‹</label>
            <input type="range" id="betSize" min="5" max="50" value="20" step="5">
            <div class="value-display"><span id="betSizeValue">20</span>%</div>
          </div>

          <div class="control-group">
            <label>äº¤æ˜“æ¬¡æ•°</label>
            <input type="range" id="trades" min="10" max="100" value="50" step="10">
            <div class="value-display"><span id="tradesValue">50</span>æ¬¡</div>
          </div>

          <button onclick="runSimulation()">å¼€å§‹æ¨¡æ‹Ÿ</button>
          <button onclick="runMultipleSimulations()" style="background: linear-gradient(135deg, #4a90e2, #357abd); color: white;">è¿è¡Œ1000æ¬¡çœ‹åˆ†å¸ƒ</button>
        </div>

        <div class="chart-container">
          <canvas id="equityChart"></canvas>
        </div>
      </div>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-label">æœ€ç»ˆæ”¶ç›Šç‡</div>
          <div class="stat-value" id="finalReturn">0%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">æœ€å¤§å›æ’¤</div>
          <div class="stat-value negative" id="maxDrawdown">0%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">èƒœç‡</div>
          <div class="stat-value" id="actualWinRate">0%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ç ´äº§æ¦‚ç‡</div>
          <div class="stat-value" id="ruinProb">0%</div>
        </div>
      </div>

      <div class="insight">
        <div class="insight-title">ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ</div>
        <div class="insight-text" id="insight1">
          è°ƒæ•´å‚æ•°åç‚¹å‡»"å¼€å§‹æ¨¡æ‹Ÿ"æŸ¥çœ‹ç»“æœ
        </div>
      </div>
    </div>

    <div class="card">
      <h2>éš¾ç‚¹äºŒï¼šå¿ƒç†åšå¼ˆ - çŸ¥é“â‰ åšåˆ°</h2>
      <div class="simulator">
        <div class="control-panel">
          <div class="control-group">
            <label>æ­¢æŸçºªå¾‹ï¼ˆ0=å®Œå…¨ä¸æ­¢æŸï¼‰</label>
            <input type="range" id="discipline" min="0" max="100" value="50" step="10">
            <div class="value-display"><span id="disciplineValue">50</span>%</div>
          </div>

          <div class="control-group">
            <label>æƒ…ç»ªåŒ–ç¨‹åº¦ï¼ˆè¿½æ¶¨æ€è·Œï¼‰</label>
            <input type="range" id="emotion" min="0" max="100" value="30" step="10">
            <div class="value-display"><span id="emotionValue">30</span>%</div>
          </div>

          <button onclick="runPsychologySimulation()">æ¨¡æ‹Ÿå¿ƒç†å› ç´ å½±å“</button>
        </div>

        <div class="chart-container">
          <canvas id="psychologyChart"></canvas>
        </div>
      </div>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-label">ç†æ€§ç­–ç•¥æ”¶ç›Š</div>
          <div class="stat-value positive" id="rationalReturn">0%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å®é™…æ‰§è¡Œæ”¶ç›Š</div>
          <div class="stat-value" id="actualReturn">0%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å¿ƒç†æˆæœ¬</div>
          <div class="stat-value negative" id="psychCost">0%</div>
        </div>
      </div>

      <div class="insight">
        <div class="insight-title">ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ</div>
        <div class="insight-text" id="insight2">
          è°ƒæ•´å‚æ•°åç‚¹å‡»"æ¨¡æ‹Ÿå¿ƒç†å› ç´ å½±å“"æŸ¥çœ‹ç»“æœ
        </div>
      </div>
    </div>

    <div class="card">
      <h2>éš¾ç‚¹ä¸‰ï¼šæ—¶é—´é™·é˜± - é•¿æœŸç”Ÿå­˜æ‰æ˜¯ç‹é“</h2>
      <div class="insight">
        <div class="insight-title">ğŸ² ç”Ÿå­˜æ¸¸æˆ</div>
        <div class="insight-text">
          å‡è®¾ä½ æœ‰60%èƒœç‡ï¼Œæ¯æ¬¡èµš10%æˆ–äº10%ï¼ŒæŠ•å…¥20%æœ¬é‡‘ã€‚<br>
          çœ‹èµ·æ¥å¾ˆç¨³ï¼Ÿä½†è¿ç»­äº5æ¬¡çš„æ¦‚ç‡æ˜¯ <strong>1.02%</strong>ï¼Œæ„å‘³ç€æ¯100ä¸ªäººå°±æœ‰1ä¸ªä¼šé‡åˆ°ã€‚<br>
          å¦‚æœé‡åˆ°ï¼Œä½ çš„æœ¬é‡‘ä¼šä» 100ä¸‡ â†’ 80ä¸‡ â†’ 64ä¸‡ â†’ 51.2ä¸‡ â†’ 41ä¸‡ â†’ 32.8ä¸‡<br>
          <strong>äºæŸ67.2%ï¼Œéœ€è¦æ¶¨205%æ‰èƒ½å›æœ¬ã€‚</strong>
        </div>
      </div>
    </div>
  </div>

  <script>
    let equityChart, psychologyChart;

    // åˆå§‹åŒ–å›¾è¡¨
    function initCharts() {
      const chartConfig = {
        type: 'line',
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              labels: { color: '#e0e0e0' }
            }
          },
          scales: {
            x: { 
              ticks: { color: '#b0b0b0' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: { 
              ticks: { color: '#b0b0b0' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          }
        }
      };

      const ctx1 = document.getElementById('equityChart').getContext('2d');
      equityChart = new Chart(ctx1, {
        ...chartConfig,
        data: { labels: [], datasets: [] }
      });

      const ctx2 = document.getElementById('psychologyChart').getContext('2d');
      psychologyChart = new Chart(ctx2, {
        ...chartConfig,
        data: { labels: [], datasets: [] }
      });
    }

    // æ›´æ–°æ˜¾ç¤ºå€¼
    document.getElementById('winRate').oninput = (e) => {
      document.getElementById('winRateValue').textContent = e.target.value;
    };
    document.getElementById('profitLossRatio').oninput = (e) => {
      document.getElementById('ratioValue').textContent = parseFloat(e.target.value).toFixed(1);
    };
    document.getElementById('betSize').oninput = (e) => {
      document.getElementById('betSizeValue').textContent = e.target.value;
    };
    document.getElementById('trades').oninput = (e) => {
      document.getElementById('tradesValue').textContent = e.target.value;
    };
    document.getElementById('discipline').oninput = (e) => {
      document.getElementById('disciplineValue').textContent = e.target.value;
    };
    document.getElementById('emotion').oninput = (e) => {
      document.getElementById('emotionValue').textContent = e.target.value;
    };

    function runSimulation() {
      const winRate = parseFloat(document.getElementById('winRate').value) / 100;
      const ratio = parseFloat(document.getElementById('profitLossRatio').value);
      const betSize = parseFloat(document.getElementById('betSize').value) / 100;
      const trades = parseInt(document.getElementById('trades').value);

      let capital = 100;
      const equity = [capital];
      let wins = 0;
      let maxCapital = capital;
      let maxDrawdown = 0;

      for (let i = 0; i < trades; i++) {
        const isWin = Math.random() < winRate;
        if (isWin) {
          capital += capital * betSize * ratio;
          wins++;
        } else {
          capital -= capital * betSize;
        }
        equity.push(capital);

        if (capital > maxCapital) maxCapital = capital;
        const drawdown = (maxCapital - capital) / maxCapital * 100;
        if (drawdown > maxDrawdown) maxDrawdown = drawdown;
      }

      // æ›´æ–°å›¾è¡¨
      equityChart.data.labels = equity.map((_, i) => i);
      equityChart.data.datasets = [{
        label: 'èµ„é‡‘æ›²çº¿',
        data: equity,
        borderColor: capital > 100 ? '#44ff44' : '#ff4444',
        backgroundColor: 'rgba(255, 215, 0, 0.1)',
        tension: 0.4
      }];
      equityChart.update();

      // æ›´æ–°ç»Ÿè®¡
      const finalReturn = ((capital - 100) / 100 * 100).toFixed(1);
      document.getElementById('finalReturn').textContent = finalReturn + '%';
      document.getElementById('finalReturn').className = 'stat-value ' + (capital > 100 ? 'positive' : 'negative');
      document.getElementById('maxDrawdown').textContent = '-' + maxDrawdown.toFixed(1) + '%';
      document.getElementById('actualWinRate').textContent = (wins / trades * 100).toFixed(1) + '%';

      // è®¡ç®—ç ´äº§æ¦‚ç‡ï¼ˆç®€åŒ–ç‰ˆKellyå…¬å¼ï¼‰
      const q = 1 - winRate;
      const ruinProb = q > winRate * ratio ? 100 : (Math.pow(q / (winRate * ratio), capital / 10) * 100);
      document.getElementById('ruinProb').textContent = Math.min(ruinProb, 100).toFixed(1) + '%';

      // ç”Ÿæˆæ´å¯Ÿ
      let insight = '';
      const expectedValue = winRate * ratio - (1 - winRate);
      
      if (expectedValue > 0) {
        insight = `æ•°å­¦æœŸæœ›ä¸ºæ­£(${(expectedValue * 100).toFixed(1)}%)ï¼Œç†è®ºä¸Šé•¿æœŸä¼šèµšé’±ã€‚`;
      } else {
        insight = `æ•°å­¦æœŸæœ›ä¸ºè´Ÿ(${(expectedValue * 100).toFixed(1)}%)ï¼Œè¿™æ˜¯ä¸ªè´ŸæœŸæœ›æ¸¸æˆï¼Œé•¿æœŸå¿…äºï¼`;
      }

      if (maxDrawdown > 30) {
        insight += ` ä½†æœ€å¤§å›æ’¤${maxDrawdown.toFixed(1)}%ï¼Œå¤šæ•°äººä¼šåœ¨ä¸­é€”å´©æºƒç¦»åœºã€‚`;
      }

      if (betSize > 0.3) {
        insight += ` æ¯æ¬¡æŠ•å…¥${(betSize * 100).toFixed(0)}%å¤ªæ¿€è¿›ï¼Œå®¹æ˜“çˆ†ä»“ã€‚`;
      }

      document.getElementById('insight1').textContent = insight;
    }

    function runMultipleSimulations() {
      const winRate = parseFloat(document.getElementById('winRate').value) / 100;
      const ratio = parseFloat(document.getElementById('profitLossRatio').value);
      const betSize = parseFloat(document.getElementById('betSize').value) / 100;
      const trades = parseInt(document.getElementById('trades').value);

      const results = [];
      let totalWins = 0;
      let maxDrawdownSum = 0;
      
      for (let sim = 0; sim < 1000; sim++) {
        let capital = 100;
        let wins = 0;
        let maxCapital = capital;
        let maxDrawdown = 0;
        
        for (let i = 0; i < trades; i++) {
          const isWin = Math.random() < winRate;
          if (isWin) {
            capital += capital * betSize * ratio;
            wins++;
          } else {
            capital -= capital * betSize;
          }
          
          if (capital > maxCapital) maxCapital = capital;
          const drawdown = (maxCapital - capital) / maxCapital * 100;
          if (drawdown > maxDrawdown) maxDrawdown = drawdown;
        }
        
        results.push(capital);
        totalWins += wins;
        maxDrawdownSum += maxDrawdown;
      }

      // ç»Ÿè®¡åˆ†å¸ƒ - æ ¹æ®å®é™…ç»“æœåŠ¨æ€åˆ†æ¡¶
      results.sort((a, b) => a - b);
      const losers = results.filter(r => r < 100);
      const winners = results.filter(r => r >= 100);

      // äºæŸåŒºé—´æŒ‰ç™¾åˆ†ä½åˆ†3æ¡¶ï¼Œç›ˆåˆ©åŒºé—´æŒ‰ç™¾åˆ†ä½åˆ†4æ¡¶
      function makeBins(arr, numBins) {
        if (arr.length === 0) return [];
        const bins = [];
        for (let i = 0; i < numBins; i++) {
          const idx = Math.floor(i / numBins * arr.length);
          bins.push(arr[idx]);
        }
        bins.push(arr[arr.length - 1] + 0.01);
        return bins;
      }

      // å›ºå®šä»¥100ä¸ºåˆ†ç•Œï¼Œç”¨å¯¹æ•°åˆ»åº¦åˆ†æ¡¶
      const allMin = Math.floor(results[0]);
      const allMax = Math.ceil(results[results.length - 1]);
      const bins = [allMin];
      
      // äºæŸä¾§
      if (allMin < 100) {
        const lossSteps = [25, 50, 75, 100];
        lossSteps.forEach(s => { if (s > allMin) bins.push(s); });
      }
      if (bins[bins.length - 1] !== 100) bins.push(100);
      
      // ç›ˆåˆ©ä¾§
      const winSteps = [150, 250, 500, 1000, 5000];
      winSteps.forEach(s => { if (s < allMax) bins.push(s); });
      bins.push(allMax + 1);

      // å»é‡å¹¶æ’åº
      const uniqueBins = [...new Set(bins)].sort((a, b) => a - b);

      const distribution = new Array(uniqueBins.length - 1).fill(0);
      results.forEach(r => {
        for (let i = 0; i < uniqueBins.length - 1; i++) {
          if (r >= uniqueBins[i] && r < uniqueBins[i + 1]) {
            distribution[i]++;
            break;
          }
        }
      });

      const labels = uniqueBins.slice(0, -1).map((v, i) => {
        const lower = Math.round(v) - 100;
        const upper = uniqueBins[i + 1] >= allMax ? 'âˆ' : Math.round(uniqueBins[i + 1]) - 100;
        const fmtLower = lower >= 0 ? `+${lower}%` : `${lower}%`;
        const fmtUpper = upper === 'âˆ' ? 'âˆ' : (upper >= 0 ? `+${upper}%` : `${upper}%`);
        return `${fmtLower}~${fmtUpper}`;
      });
      
      equityChart.data.labels = labels;
      equityChart.data.datasets = [{
        label: '1000æ¬¡æ¨¡æ‹Ÿç»“æœåˆ†å¸ƒ',
        data: distribution,
        backgroundColor: distribution.map((_, i) => {
          if (uniqueBins[i + 1] <= 100) return 'rgba(255, 68, 68, 0.6)';
          if (uniqueBins[i] < 100) return 'rgba(255, 215, 0, 0.6)';
          return 'rgba(68, 255, 68, 0.6)';
        }),
        borderColor: '#ffd700',
        borderWidth: 1
      }];
      equityChart.options.scales.y.title = { display: true, text: 'æ¬¡æ•°', color: '#b0b0b0' };
      equityChart.options.scales.x.title = { display: true, text: 'æœ€ç»ˆæ”¶ç›Šç‡ï¼ˆåˆå§‹æœ¬é‡‘=100%ï¼‰', color: '#b0b0b0' };
      equityChart.config.type = 'bar';
      equityChart.update();

      // æ›´æ–°ç»Ÿè®¡æ•°æ® - åŸºäº1000æ¬¡æ¨¡æ‹Ÿ
      const avgFinalCapital = results.reduce((sum, r) => sum + r, 0) / 1000;
      const avgReturn = ((avgFinalCapital - 100) / 100 * 100).toFixed(1);
      const profitCount = results.filter(r => r > 100).length;
      const lossCount = results.filter(r => r < 100).length;
      const avgWinRate = (totalWins / (1000 * trades) * 100).toFixed(1);
      const avgMaxDrawdown = (maxDrawdownSum / 1000).toFixed(1);
      const ruinRate = (lossCount / 1000 * 100).toFixed(1);

      document.getElementById('finalReturn').textContent = avgReturn + '%';
      document.getElementById('finalReturn').className = 'stat-value ' + (avgFinalCapital > 100 ? 'positive' : 'negative');
      document.getElementById('maxDrawdown').textContent = '-' + avgMaxDrawdown + '%';
      document.getElementById('actualWinRate').textContent = avgWinRate + '%';
      document.getElementById('ruinProb').textContent = ruinRate + '%';

      document.getElementById('insight1').textContent = 
        `è¿è¡Œ1000æ¬¡æ¨¡æ‹Ÿï¼š${lossCount}æ¬¡äºæŸï¼Œ${profitCount}æ¬¡ç›ˆåˆ©ï¼Œ${1000 - profitCount - lossCount}æ¬¡æŒå¹³ã€‚å¹³å‡æ”¶ç›Š${avgReturn}%ï¼Œå¹³å‡å›æ’¤${avgMaxDrawdown}%ã€‚å³ä½¿èƒœç‡${(winRate * 100).toFixed(0)}%ï¼Œä»æœ‰${ruinRate}%çš„äººæœ€ç»ˆäºé’±ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ"ä¸ƒäºäºŒå¹³ä¸€èµš"ã€‚`;
    }

    function runPsychologySimulation() {
      const discipline = parseFloat(document.getElementById('discipline').value) / 100;
      const emotion = parseFloat(document.getElementById('emotion').value) / 100;

      // ç†æ€§ç­–ç•¥ï¼šå›ºå®šä»“ä½ï¼Œä¸¥æ ¼æ­¢æŸ
      let rationalCapital = 100;
      const rationalEquity = [rationalCapital];
      
      // å®é™…æ‰§è¡Œï¼šå—æƒ…ç»ªå½±å“
      let actualCapital = 100;
      const actualEquity = [actualCapital];

      const trades = 50;
      const baseWinRate = 0.55;
      const baseBetSize = 0.15;

      for (let i = 0; i < trades; i++) {
        // ç†æ€§ç­–ç•¥
        const isWin = Math.random() < baseWinRate;
        if (isWin) {
          rationalCapital *= (1 + baseBetSize);
        } else {
          rationalCapital *= (1 - baseBetSize);
        }
        rationalEquity.push(rationalCapital);

        // å®é™…æ‰§è¡Œ
        let actualBetSize = baseBetSize;
        
        // æƒ…ç»ªåŒ–ï¼šè¿äºååŠ ä»“ï¼ˆæƒ³å›æœ¬ï¼‰
        if (i > 0 && actualEquity[i] < actualEquity[i - 1]) {
          actualBetSize *= (1 + emotion);
        }
        
        // çºªå¾‹æ€§ï¼šè¯¥æ­¢æŸæ—¶ä¸æ­¢æŸ
        const shouldStopLoss = !isWin && Math.random() > discipline;
        
        if (isWin) {
          actualCapital *= (1 + actualBetSize);
        } else {
          if (shouldStopLoss) {
            // ä¸æ­¢æŸï¼Œäºå¾—æ›´å¤š
            actualCapital *= (1 - actualBetSize * 1.5);
          } else {
            actualCapital *= (1 - actualBetSize);
          }
        }
        actualEquity.push(actualCapital);
      }

      // æ›´æ–°å›¾è¡¨
      psychologyChart.data.labels = rationalEquity.map((_, i) => i);
      psychologyChart.data.datasets = [
        {
          label: 'ç†æ€§ç­–ç•¥',
          data: rationalEquity,
          borderColor: '#44ff44',
          backgroundColor: 'rgba(68, 255, 68, 0.1)',
          tension: 0.4
        },
        {
          label: 'å®é™…æ‰§è¡Œ',
          data: actualEquity,
          borderColor: '#ff4444',
          backgroundColor: 'rgba(255, 68, 68, 0.1)',
          tension: 0.4
        }
      ];
      psychologyChart.config.type = 'line';
      psychologyChart.update();

      // æ›´æ–°ç»Ÿè®¡
      const rationalReturn = ((rationalCapital - 100) / 100 * 100).toFixed(1);
      const actualReturn = ((actualCapital - 100) / 100 * 100).toFixed(1);
      const psychCost = (rationalReturn - actualReturn).toFixed(1);

      document.getElementById('rationalReturn').textContent = rationalReturn + '%';
      document.getElementById('actualReturn').textContent = actualReturn + '%';
      document.getElementById('actualReturn').className = 'stat-value ' + (actualCapital > 100 ? 'positive' : 'negative');
      document.getElementById('psychCost').textContent = psychCost + '%';

      // ç”Ÿæˆæ´å¯Ÿ
      let insight = `ç†æ€§ç­–ç•¥èƒ½èµš${rationalReturn}%ï¼Œä½†å› ä¸º`;
      if (discipline < 0.5) insight += 'æ­¢æŸçºªå¾‹å·®ã€';
      if (emotion > 0.3) insight += 'æƒ…ç»ªåŒ–è¿½æ¶¨æ€è·Œã€';
      insight += `å®é™…åªèµš${actualReturn}%ã€‚å¿ƒç†æˆæœ¬é«˜è¾¾${psychCost}%ï¼`;
      
      if (actualCapital < rationalCapital * 0.8) {
        insight += ' è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šäººæ˜æ˜çŸ¥é“æ–¹æ³•ï¼Œå´è¿˜æ˜¯äºé’±ã€‚';
      }

      document.getElementById('insight2').textContent = insight;
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = () => {
      initCharts();
    };
  </script>
</body>
</html>
