<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIé¢œå€¼è¯„åˆ†å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="../components/header.js" defer></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }
    .container { max-width: 800px; margin: 0 auto; }
    .back-link {
      display: inline-block;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    .back-link:hover { text-decoration: underline; }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.8rem;
      background: linear-gradient(135deg, #ff6b9d, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle {
      text-align: center;
      color: rgba(255,255,255,0.6);
      margin-bottom: 25px;
      font-size: 0.9rem;
    }
    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
</style>
</head>
<body>
  <div class="container">
    <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
    <h1>âœ¨ AIé¢œå€¼è¯„åˆ†å™¨</h1>
    <p class="subtitle">ä¸Šä¼ ç…§ç‰‡ï¼ŒAI åˆ†æä½ çš„é¢œå€¼ï¼ˆä»…ä¾›å¨±ä¹ï¼‰</p>

    <div class="card">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ğŸ“·</div>
        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç…§ç‰‡</p>
        <p class="upload-hint">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®æ­£è„¸ç…§ç‰‡</p>
        <input type="file" id="fileInput" accept="image/*" hidden>
      </div>
      
      <div class="preview-area" id="previewArea" style="display:none;">
        <div class="image-container">
          <img id="previewImg" src="" alt="é¢„è§ˆ">
          <canvas id="faceCanvas"></canvas>
        </div>
        <button class="btn-reupload" onclick="resetUpload()">é‡æ–°ä¸Šä¼ </button>
      </div>
      
      <div class="loading" id="loading" style="display:none;">
        <div class="spinner"></div>
        <p>AI æ­£åœ¨åˆ†æä¸­...</p>
      </div>
    </div>

    <div class="card result-card" id="resultCard" style="display:none;">
      <div class="score-display">
        <div class="score-circle">
          <svg viewBox="0 0 100 100">
            <circle class="score-bg" cx="50" cy="50" r="45"/>
            <circle class="score-progress" id="scoreCircle" cx="50" cy="50" r="45"/>
          </svg>
          <div class="score-value" id="scoreValue">0</div>
        </div>
        <div class="score-label" id="scoreLabel">åˆ†æä¸­...</div>
      </div>
      
      <div class="details">
        <h3>ğŸ“Š è¯¦ç»†åˆ†æ</h3>
        <div class="detail-grid" id="detailGrid"></div>
      </div>
      
      <div class="comment" id="comment"></div>
      
      <div class="disclaimer">
        âš ï¸ æœ¬å·¥å…·ä»…ä¾›å¨±ä¹ï¼Œè¯„åˆ†åŸºäºç®€å•çš„é¢éƒ¨ç‰¹å¾åˆ†æï¼Œä¸ä»£è¡¨çœŸå®å®¡ç¾æ ‡å‡†ã€‚é¢œå€¼æ˜¯ä¸»è§‚çš„ï¼Œè‡ªä¿¡æœ€é‡è¦ï¼
      </div>
    </div>
  </div>

  <style>
    .upload-area {
      border: 2px dashed rgba(255,255,255,0.3);
      border-radius: 16px;
      padding: 50px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .upload-area:hover {
      border-color: #ff6b9d;
      background: rgba(255,107,157,0.1);
    }
    .upload-area.dragover {
      border-color: #ffd700;
      background: rgba(255,215,0,0.1);
    }
    .upload-icon { font-size: 60px; margin-bottom: 15px; }
    .upload-area p { color: rgba(255,255,255,0.8); margin-bottom: 8px; }
    .upload-hint { font-size: 0.85rem; color: rgba(255,255,255,0.5) !important; }
    
    .preview-area { text-align: center; }
    .image-container {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }
    #previewImg {
      max-width: 100%;
      max-height: 400px;
      border-radius: 12px;
    }
    #faceCanvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    .btn-reupload {
      margin-top: 15px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 10px 25px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-reupload:hover { background: rgba(255,255,255,0.2); }
    
    .loading { text-align: center; padding: 40px; }
    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #ff6b9d;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .result-card { text-align: center; }
    .score-display { margin-bottom: 30px; }
    .score-circle {
      position: relative;
      width: 180px;
      height: 180px;
      margin: 0 auto 15px;
    }
    .score-circle svg { transform: rotate(-90deg); }
    .score-bg {
      fill: none;
      stroke: rgba(255,255,255,0.1);
      stroke-width: 8;
    }
    .score-progress {
      fill: none;
      stroke: url(#scoreGradient);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      transition: stroke-dashoffset 1.5s ease;
    }
    .score-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      font-weight: bold;
      color: #ffd700;
    }
    .score-label {
      font-size: 1.5rem;
      font-weight: bold;
      color: #ff6b9d;
    }
</style>

  <style>
    .details { text-align: left; margin: 25px 0; }
    .details h3 { color: #ffd700; margin-bottom: 15px; }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    @media (max-width: 500px) {
      .detail-grid { grid-template-columns: 1fr; }
    }
    .detail-item {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 12px 15px;
    }
    .detail-label {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 5px;
    }
    .detail-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
    }
    .detail-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 1s ease;
    }
    .detail-value {
      font-size: 0.9rem;
      color: #ffd700;
      margin-top: 5px;
    }
    
    .comment {
      background: linear-gradient(135deg, rgba(255,107,157,0.2), rgba(255,215,0,0.1));
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      font-size: 1.1rem;
      line-height: 1.8;
      color: rgba(255,255,255,0.9);
    }
    
    .disclaimer {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.4);
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      line-height: 1.6;
    }
  </style>
  
  <svg style="position:absolute;width:0;height:0;">
    <defs>
      <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#ff6b9d"/>
        <stop offset="100%" style="stop-color:#ffd700"/>
      </linearGradient>
    </defs>
  </svg>

  <script>
    let modelsLoaded = false;
    
    // åŠ è½½ face-api æ¨¡å‹
    async function loadModels() {
      const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL),
        faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL)
      ]);
      modelsLoaded = true;
    }
    
    // é¡µé¢åŠ è½½æ—¶é¢„åŠ è½½æ¨¡å‹
    loadModels().catch(console.error);
    
    // ä¸Šä¼ åŒºåŸŸäº‹ä»¶
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        handleFile(file);
      }
    });
    fileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) handleFile(e.target.files[0]);
    });
    
    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('previewImg').src = e.target.result;
        document.getElementById('uploadArea').style.display = 'none';
        document.getElementById('previewArea').style.display = 'block';
        analyzeImage();
      };
      reader.readAsDataURL(file);
    }
    
    function resetUpload() {
      document.getElementById('uploadArea').style.display = 'block';
      document.getElementById('previewArea').style.display = 'none';
      document.getElementById('resultCard').style.display = 'none';
      document.getElementById('loading').style.display = 'none';
      fileInput.value = '';
    }

    async function analyzeImage() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('resultCard').style.display = 'none';
      
      // ç­‰å¾…æ¨¡å‹åŠ è½½
      if (!modelsLoaded) {
        await loadModels();
      }
      
      const img = document.getElementById('previewImg');
      await new Promise(resolve => {
        if (img.complete) resolve();
        else img.onload = resolve;
      });
      
      // è®¾ç½® canvas
      const canvas = document.getElementById('faceCanvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      
      try {
        // æ£€æµ‹äººè„¸
        const detection = await faceapi
          .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
          .withFaceLandmarks()
          .withFaceExpressions()
          .withAgeAndGender();
        
        if (!detection) {
          alert('æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·ä¸Šä¼ æ¸…æ™°çš„æ­£è„¸ç…§ç‰‡');
          resetUpload();
          return;
        }
        
        // ç»˜åˆ¶äººè„¸æ¡†å’Œç‰¹å¾ç‚¹
        const resized = faceapi.resizeResults(detection, { width: img.width, height: img.height });
        faceapi.draw.drawDetections(canvas, resized);
        faceapi.draw.drawFaceLandmarks(canvas, resized);
        
        // åˆ†æå¹¶æ˜¾ç¤ºç»“æœ
        const result = analyzeFeatures(detection);
        showResult(result, detection);
        
      } catch (err) {
        console.error(err);
        alert('åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•');
        resetUpload();
      }
      
      document.getElementById('loading').style.display = 'none';
    }
    
    function analyzeFeatures(detection) {
      const landmarks = detection.landmarks;
      const positions = landmarks.positions;
      
      // è®¡ç®—å„ç§é¢éƒ¨æ¯”ä¾‹
      const leftEye = landmarks.getLeftEye();
      const rightEye = landmarks.getRightEye();
      const nose = landmarks.getNose();
      const mouth = landmarks.getMouth();
      const jaw = landmarks.getJawOutline();
      
      // çœ¼é—´è·æ¯”ä¾‹
      const eyeDistance = Math.abs(rightEye[0].x - leftEye[3].x);
      const faceWidth = Math.abs(jaw[16].x - jaw[0].x);
      const eyeRatio = eyeDistance / faceWidth;
      
      // ä¸‰åº­æ¯”ä¾‹ï¼ˆé¢å¤´:é¼»å­:ä¸‹å·´ï¼‰
      const faceTop = Math.min(...positions.map(p => p.y));
      const eyeY = (leftEye[0].y + rightEye[0].y) / 2;
      const noseBottom = nose[6].y;
      const chinBottom = jaw[8].y;
      
      // äº”çœ¼æ¯”ä¾‹
      const leftEyeWidth = Math.abs(leftEye[3].x - leftEye[0].x);
      const rightEyeWidth = Math.abs(rightEye[3].x - rightEye[0].x);
      const avgEyeWidth = (leftEyeWidth + rightEyeWidth) / 2;
      const fiveEyeRatio = faceWidth / avgEyeWidth;
      
      // å˜´å·´æ¯”ä¾‹
      const mouthWidth = Math.abs(mouth[6].x - mouth[0].x);
      const mouthRatio = mouthWidth / faceWidth;
      
      // å¯¹ç§°æ€§
      const leftSide = positions.slice(0, 8);
      const rightSide = positions.slice(9, 17).reverse();
      let symmetryScore = 0;
      const centerX = jaw[8].x;
      for (let i = 0; i < Math.min(leftSide.length, rightSide.length); i++) {
        const leftDist = Math.abs(leftSide[i].x - centerX);
        const rightDist = Math.abs(rightSide[i].x - centerX);
        symmetryScore += 1 - Math.abs(leftDist - rightDist) / faceWidth;
      }
      symmetryScore = symmetryScore / Math.min(leftSide.length, rightSide.length);
      
      // è¡¨æƒ…åˆ†æ•°
      const expressions = detection.expressions;
      const happyScore = expressions.happy || 0;
      const neutralScore = expressions.neutral || 0;
      
      // æ›´ä¸¥æ ¼çš„è¯„åˆ†æ ‡å‡†ï¼Œå¢åŠ åŒºåˆ†åº¦
      // çœ¼é—´è·ç†æƒ³å€¼çº¦0.28-0.32ï¼Œåç¦»è¶Šå¤šæ‰£åˆ†è¶Šç‹ 
      const idealEyeRatio = 0.30;
      const eyeScore = Math.max(0, 1 - Math.abs(eyeRatio - idealEyeRatio) / 0.15);
      
      // äº”çœ¼æ¯”ä¾‹ç†æƒ³å€¼5ï¼Œåç¦»æ‰£åˆ†
      const fiveEyeScore = Math.max(0, 1 - Math.abs(fiveEyeRatio - 5) / 2);
      
      // å˜´å®½æ¯”ä¾‹ç†æƒ³å€¼0.38-0.42
      const idealMouthRatio = 0.40;
      const mouthScore = Math.max(0, 1 - Math.abs(mouthRatio - idealMouthRatio) / 0.15);
      
      // å¯¹ç§°æ€§æ›´ä¸¥æ ¼
      const symmetryFinal = Math.pow(symmetryScore, 2); // å¹³æ–¹æ”¾å¤§å·®å¼‚
      
      // è¡¨æƒ…åˆ†æ•°é™ä½æƒé‡
      const expressionScore = happyScore * 0.3 + neutralScore * 0.3;
      
      // åŠ å…¥éšæœºæ‰°åŠ¨ï¼Œé¿å…æ‰€æœ‰äººåˆ†æ•°ä¸€æ ·ï¼ˆÂ±5åˆ†ï¼‰
      const randomFactor = (Math.random() - 0.5) * 0.1;
      
      return {
        eyeRatio: eyeScore,
        fiveEyeRatio: fiveEyeScore,
        mouthRatio: mouthScore,
        symmetry: symmetryFinal,
        expression: expressionScore,
        random: randomFactor,
        age: detection.age,
        gender: detection.gender
      };
    }

    function showResult(result, detection) {
      // è®¡ç®—æ€»åˆ†ï¼ŒèŒƒå›´æ›´å¤§ (50-92)
      const rawScore = (
        result.eyeRatio * 0.2 +
        result.fiveEyeRatio * 0.2 +
        result.mouthRatio * 0.15 +
        result.symmetry * 0.35 +
        result.expression * 0.1 +
        result.random
      );
      // æ˜ å°„åˆ° 50-92 åˆ†ï¼Œæ›´æœ‰åŒºåˆ†åº¦
      const score = Math.round(50 + Math.max(0, Math.min(1, rawScore)) * 42);
      
      // æ˜¾ç¤ºåˆ†æ•°åŠ¨ç”»
      const scoreCircle = document.getElementById('scoreCircle');
      const scoreValue = document.getElementById('scoreValue');
      const scoreLabel = document.getElementById('scoreLabel');
      
      document.getElementById('resultCard').style.display = 'block';
      
      // åœ†ç¯åŠ¨ç”»
      const circumference = 283;
      const offset = circumference - (score / 100) * circumference;
      setTimeout(() => {
        scoreCircle.style.strokeDashoffset = offset;
      }, 100);
      
      // æ•°å­—åŠ¨ç”»
      let current = 0;
      const interval = setInterval(() => {
        current += 1;
        scoreValue.textContent = current;
        if (current >= score) clearInterval(interval);
      }, 20);
      
      // è¯„çº§ - è°ƒæ•´é˜ˆå€¼
      let label = '';
      if (score >= 88) label = 'ç»ä¸–å®¹é¢œ âœ¨';
      else if (score >= 82) label = 'å€¾å›½å€¾åŸ ğŸ’';
      else if (score >= 76) label = 'è‹±ä¿Šæ½‡æ´’ ğŸŒŸ';
      else if (score >= 70) label = 'æ¸…ç§€å¯äºº ğŸ’«';
      else if (score >= 64) label = 'çœ‰æ¸…ç›®ç§€ â­';
      else if (score >= 58) label = 'æœ´å®æ— å ğŸŒ±';
      else label = 'ç‹¬ç‰¹é­…åŠ› ğŸ­';
      scoreLabel.textContent = label;
      
      // è¯¦ç»†åˆ†æ
      const details = [
        { label: 'é¢éƒ¨å¯¹ç§°', value: result.symmetry, color: '#ff6b9d' },
        { label: 'çœ¼é—´è·æ¯”ä¾‹', value: result.eyeRatio, color: '#ffd700' },
        { label: 'äº”çœ¼æ¯”ä¾‹', value: result.fiveEyeRatio, color: '#4ade80' },
        { label: 'å˜´å‹æ¯”ä¾‹', value: result.mouthRatio, color: '#00d4ff' },
        { label: 'è¡¨æƒ…äº²å’Œ', value: result.expression, color: '#a855f7' },
        { label: 'ç»¼åˆæ°”è´¨', value: rawScore, color: '#ff6b6b' }
      ];
      
      const detailGrid = document.getElementById('detailGrid');
      detailGrid.innerHTML = details.map(d => `
        <div class="detail-item">
          <div class="detail-label">${d.label}</div>
          <div class="detail-bar">
            <div class="detail-fill" style="width:${d.value * 100}%;background:${d.color}"></div>
          </div>
          <div class="detail-value">${(d.value * 100).toFixed(0)}åˆ†</div>
        </div>
      `).join('');
      
      // è¯„è¯­
      const genderText = result.gender === 'male' ? 'å¸…å“¥' : 'ç¾å¥³';
      const ageText = Math.round(result.age);
      const comments = getComment(score, result.gender, ageText);
      document.getElementById('comment').innerHTML = comments;
    }
    
    function getComment(score, gender, age) {
      const genderText = gender === 'male' ? 'å¸…å“¥' : 'ç¾å¥³';
      
      if (score >= 90) {
        return `å“‡ï¼AI é¢„ä¼°å¹´é¾„ ${age} å²çš„${genderText}ï¼Œè¿™é¢œå€¼ç®€ç›´æ˜¯è€å¤©çˆ·è¿½ç€å–‚é¥­åƒï¼é¢éƒ¨æ¯”ä¾‹å ªç§°é»„é‡‘åˆ†å‰²ï¼Œå¯¹ç§°åº¦æé«˜ã€‚èµ°åœ¨è¡—ä¸Šå›å¤´ç‡ 200%ï¼Œå»ºè®®å‡ºé“ï¼`;
      } else if (score >= 85) {
        return `AI é¢„ä¼°å¹´é¾„ ${age} å²ï¼Œ${genderText}ä½ è¿™é•¿ç›¸ï¼Œæ”¾å¤ä»£å¦¥å¦¥çš„"æ²‰é±¼è½é›"çº§åˆ«ã€‚äº”å®˜ç²¾è‡´ï¼Œæ¯”ä¾‹åè°ƒï¼Œæ°”è´¨å‡ºä¼—ã€‚é¢œå€¼åœ¨çº¿ï¼Œè‡ªä¿¡åŠ åˆ†ï¼`;
      } else if (score >= 80) {
        return `${age} å²çš„${genderText}ï¼Œäº”å®˜ç«¯æ­£ï¼Œæ¯”ä¾‹åè°ƒï¼Œå±äºè€çœ‹å‹é€‰æ‰‹ã€‚ç¬¬ä¸€çœ¼å¯èƒ½ä¸æƒŠè‰³ï¼Œä½†è¶Šçœ‹è¶Šé¡ºçœ¼ï¼Œè¿™ç§é•¿ç›¸æœ€æŠ—è€ï¼`;
      } else if (score >= 75) {
        return `AI çœ‹å‡ºä½ å¤§çº¦ ${age} å²ï¼Œ${genderText}ä½ çš„é•¿ç›¸å±äºæ¸…ç§€æŒ‚çš„ï¼Œè™½ç„¶ä¸æ˜¯æƒŠè‰³å‹ï¼Œä½†èƒœåœ¨èˆ’æœè€çœ‹ã€‚ç¬‘èµ·æ¥åº”è¯¥å¾ˆå¥½çœ‹ï¼Œå¤šç¬‘ç¬‘ï¼`;
      } else if (score >= 70) {
        return `${age} å²çš„${genderText}ï¼Œé•¿ç›¸æ™®é€šä½†ä¸å¹³åº¸ã€‚è®°ä½ï¼šé¢œå€¼ä¸å¤Ÿï¼Œæ°”è´¨æ¥å‡‘ï¼è‡ªä¿¡çš„äººæœ€æœ‰é­…åŠ›ï¼Œåˆ«è¢«åˆ†æ•°å®šä¹‰ã€‚`;
      } else {
        return `${genderText}ï¼ŒAI è§‰å¾—ä½ å¤§çº¦ ${age} å²ã€‚åˆ†æ•°åªæ˜¯å¨±ä¹ï¼ŒçœŸæ­£çš„é­…åŠ›æ¥è‡ªå†…åœ¨ã€‚å†è¯´äº†ï¼Œå¥½çœ‹çš„çš®å›Šåƒç¯‡ä¸€å¾‹ï¼Œæœ‰è¶£çš„çµé­‚ä¸‡é‡ŒæŒ‘ä¸€ï¼`;
      }
    }
  </script>
</body>
</html>
