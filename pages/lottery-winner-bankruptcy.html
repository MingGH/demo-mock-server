<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å½©ç¥¨å¤´å¥–å¾—ä¸»ä¸ºä»€ä¹ˆå¤§å¤šç ´äº§ï¼Ÿè´¢å¯Œè¡°å‡æ¨¡æ‹Ÿå™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../components/header.js" defer></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh; color: #e4e4e4; padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .header { text-align: center; margin: 20px 0 30px; }
    .header h1 {
      font-size: 1.8rem; font-weight: 700;
      background: linear-gradient(90deg, #4ade80, #feca57, #4ade80);
      background-size: 200% 100%;
      background-clip: text; -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 3s ease infinite;
    }
    @keyframes shimmer { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
    .header p { color: rgba(255,255,255,0.6); margin-top: 10px; font-size: 14px; }
    .card {
      background: rgba(255,255,255,0.03); border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08); padding: 25px; margin-bottom: 20px;
    }
    .question-box {
      background: linear-gradient(135deg, rgba(74,222,128,0.1), rgba(254,202,87,0.05));
      border-left: 4px solid #4ade80; padding: 20px;
      border-radius: 0 12px 12px 0; margin-bottom: 20px; line-height: 1.9;
    }
    .question-box strong { color: #feca57; }
    .answer-box {
      text-align: center; padding: 30px 20px;
      background: linear-gradient(135deg, rgba(74,222,128,0.15), rgba(254,202,87,0.1));
      border: 2px solid #4ade80; border-radius: 16px; margin: 20px 0;
    }
    .big-answer { font-size: 2.2rem; font-weight: 800; color: #4ade80; line-height: 1.2; }
    .answer-desc { font-size: 1rem; color: rgba(255,255,255,0.8); margin-top: 15px; line-height: 1.6; }
    .setup-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin: 20px 0; }
    @media(max-width:600px){ .setup-grid{grid-template-columns:1fr} }
    .setup-item { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; text-align: center; }
    .setup-item label { display: block; color: rgba(255,255,255,0.5); font-size: 12px; margin-bottom: 8px; }
    .setup-item input, .setup-item select {
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px; padding: 10px; color: white; font-size: 16px; text-align: center;
    }
    .setup-item input:focus, .setup-item select:focus { outline: none; border-color: #4ade80; }
    .controls { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin: 20px 0; }
    .btn { padding: 12px 25px; font-size: 14px; font-weight: 600; border: none; border-radius: 25px; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #4ade80, #22c55e); color: #1a1a2e; }
    .btn-gold { background: linear-gradient(135deg, #feca57, #f0b429); color: #1a1a2e; }
    .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
    .btn:hover:not(:disabled) { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin: 20px 0; }
    @media(max-width:600px){ .stats-row{grid-template-columns:repeat(2,1fr)} }
    .stat-box { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; }
    .stat-value.green { color: #4ade80; } .stat-value.red { color: #ff6b6b; } .stat-value.gold { color: #feca57; } .stat-value.blue { color: #60a5fa; }
    .stat-label { color: rgba(255,255,255,0.5); font-size: 11px; margin-top: 5px; }
    .chart-container { position: relative; height: 350px; margin: 20px 0; }
    .analysis { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 22px; margin-top: 20px; }
    .analysis h3 { color: #feca57; margin-bottom: 15px; font-size: 1.1rem; }
    .analysis p { color: rgba(255,255,255,0.85); line-height: 1.85; margin-bottom: 14px; font-size: 14px; }
    .analysis .highlight { color: #ff6b6b; font-weight: bold; }
    .analysis .safe { color: #4ade80; font-weight: bold; }
    .conclusion {
      background: linear-gradient(135deg, rgba(74,222,128,0.15), rgba(254,202,87,0.1));
      border: 2px solid #feca57; border-radius: 16px; padding: 25px; text-align: center;
    }
    .conclusion h3 { color: #4ade80; font-size: 1.3rem; margin-bottom: 15px; }
    .conclusion p { color: rgba(255,255,255,0.85); line-height: 1.8; font-size: 14px; }
    .conclusion .key-point { color: #feca57; font-weight: 600; }
    .formula-box { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center; }
    .formula { font-family: 'Times New Roman', serif; font-size: 1.3rem; color: #feca57; margin: 10px 0; }
    .formula-desc { color: rgba(255,255,255,0.6); font-size: 13px; line-height: 1.8; }
    .tab-bar { display: flex; gap: 0; margin-bottom: 20px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .tab-btn { flex: 1; padding: 12px; text-align: center; background: rgba(0,0,0,0.2); color: rgba(255,255,255,0.5); cursor: pointer; border: none; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: rgba(74,222,128,0.15); color: #4ade80; }
    .tab-btn:hover:not(.active) { background: rgba(255,255,255,0.05); }
    .tab-content { display: none; } .tab-content.active { display: block; }
    .scenario-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin: 20px 0; }
    @media(max-width:700px){ .scenario-grid{grid-template-columns:1fr} }
    .scenario-card { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px; text-align: center; border: 2px solid transparent; transition: all 0.3s; cursor: pointer; }
    .scenario-card:hover { border-color: rgba(255,255,255,0.2); }
    .scenario-card.active { border-color: #4ade80; background: rgba(74,222,128,0.1); }
    .scenario-card h4 { color: #feca57; margin-bottom: 8px; font-size: 0.95rem; }
    .scenario-card .pct { font-size: 1.8rem; font-weight: 700; color: white; }
    .scenario-card .desc { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px; line-height: 1.5; }
    .progress-bar { width: 100%; height: 24px; background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden; margin: 10px 0; }
    .progress-fill { height: 100%; border-radius: 12px; transition: width 0.5s; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #1a1a2e; }
    .copy-btn {
      position: fixed; bottom: 20px; right: 20px; padding: 12px 20px;
      background: rgba(74,222,128,0.9); color: #1a1a2e; border: none; border-radius: 25px;
      font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(74,222,128,0.3); transition: all 0.2s;
    }
    .copy-btn:hover { transform: translateY(-2px); }
    .toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 25px;
      font-size: 14px; opacity: 0; transition: all 0.3s; z-index: 1000;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .factor-slider { margin: 15px 0; }
    .factor-slider label { display: flex; justify-content: space-between; color: rgba(255,255,255,0.6); font-size: 13px; margin-bottom: 5px; }
    .factor-slider input[type="range"] { width: 100%; accent-color: #4ade80; }
    .result-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 15px; }
    @media(max-width:500px){ .result-grid{grid-template-columns:1fr} }
    .result-card { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px; text-align: center; }
    .result-card h4 { color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 10px; }
    .result-card .big-num { font-size: 2rem; font-weight: bold; }
    .result-card .big-num.red { color: #ff6b6b; }
    .result-card .big-num.green { color: #4ade80; }
    .result-card .big-num.gold { color: #feca57; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1><i class="ti ti-ticket"></i> å½©ç¥¨å¤´å¥–å¾—ä¸»ä¸ºä»€ä¹ˆå¤§å¤šç ´äº§ï¼Ÿ</h1>
    <p>75%çš„ä¸­å¥–è€…åœ¨5å¹´å†…ç ´äº§ã€‚ä¸æ˜¯è¿æ°”é—®é¢˜ï¼Œæ˜¯æ•°å­¦å’Œå¿ƒç†çš„åŒé‡é™·é˜±</p>
  </div>
</div>

  <!-- é—®é¢˜æè¿° -->
  <div class="card">
    <div class="question-box">
      <strong>é—®é¢˜ï¼š</strong>æ®ç¾å›½å›½å®¶ç»æµç ”ç©¶å±€è°ƒæŸ¥ï¼š<br>
      <i class="ti ti-alert-triangle" style="color:#ff6b6b"></i> å½©ç¥¨ä¸­å¥–è€…çš„ç ´äº§ç‡æ¯å¹´é«˜è¾¾ <strong>75%</strong><br>
      <i class="ti ti-alert-triangle" style="color:#ff6b6b"></i> æ¯å¹´12åä¸­å¥–è€…å½“ä¸­å°±æœ‰ <strong>9åç ´äº§</strong><br>
      <i class="ti ti-alert-triangle" style="color:#ff6b6b"></i> å¤§å¤šæ•°å¤´å¥–å¾—ä¸»åœ¨ä¸­å¥–åä¸åˆ° <strong>5å¹´</strong> å†…ç©·å›°æ½¦å€’<br><br>
      ä¸ºä»€ä¹ˆçªç„¶æ‹¥æœ‰å·¨é¢è´¢å¯Œï¼Œåè€ŒåŠ é€Ÿäº†ç ´äº§ï¼Ÿ
    </div>
    <div class="answer-box">
      <div class="big-answer">è´¢å¯Œæ˜¯æµé‡ï¼Œä¸æ˜¯å­˜é‡</div>
      <div class="answer-desc">
        ä¸­å¥–åªæ”¹å˜äº†ä½ çš„å­˜é‡ï¼ˆé“¶è¡Œä½™é¢ï¼‰ï¼Œæ²¡æœ‰æ”¹å˜ä½ çš„æµé‡ï¼ˆæ”¶æ”¯ç»“æ„ï¼‰ã€‚<br>
        å½“æ”¯å‡ºå¢é€Ÿ > èµ„äº§æ”¶ç›Šç‡æ—¶ï¼Œ<span style="color:#ff6b6b;font-weight:700;">ç ´äº§åªæ˜¯æ—¶é—´é—®é¢˜</span>
      </div>
    </div>
  </div>

  <!-- æ•°å­¦æ¨¡å‹ -->
  <div class="card">
    <h2 style="color:#feca57;margin-bottom:15px;text-align:center;"><i class="ti ti-math-symbols"></i> æ•°å­¦æ¨¡å‹ï¼šè´¢å¯Œè¡°å‡æ–¹ç¨‹</h2>
    <div class="formula-box">
      <div style="color:rgba(255,255,255,0.7);margin-bottom:10px;">æ¯æœˆè´¢å¯Œå˜åŒ–</div>
      <div class="formula">W(t+1) = W(t) Ã— (1 + r/12) - E(t)</div>
      <div class="formula-desc">
        W(t) = ç¬¬tæœˆçš„è´¢å¯Œï¼Œr = å¹´æŠ•èµ„å›æŠ¥ç‡ï¼ŒE(t) = ç¬¬tæœˆçš„æ”¯å‡º<br>
        å½“ E(t) æŒç»­å¢é•¿è€Œ r ä¸å˜æ—¶ï¼ŒW å¿…ç„¶å½’é›¶
      </div>
    </div>
    <div class="formula-box">
      <div style="color:rgba(255,255,255,0.7);margin-bottom:10px;">æ”¯å‡ºè†¨èƒ€æ¨¡å‹ï¼ˆç”Ÿæ´»æ–¹å¼é€šèƒ€ï¼‰</div>
      <div class="formula">E(t) = Eâ‚€ Ã— (1 + g)^t</div>
      <div class="formula-desc">
        Eâ‚€ = åˆå§‹æœˆæ”¯å‡ºï¼Œg = æœˆæ”¯å‡ºå¢é•¿ç‡<br>
        ä¸­å¥–åæ”¯å‡ºé€šå¸¸å‘ˆæŒ‡æ•°å¢é•¿ï¼šä¹°æˆ¿ã€ä¹°è½¦ã€å€Ÿé’±ç»™äº²å‹ã€æŠ•èµ„å¤±è´¥...<br>
        <strong style="color:#ff6b6b;">å…³é”®ï¼šæŒ‡æ•°å¢é•¿çš„æ”¯å‡º vs çº¿æ€§å¢é•¿çš„åˆ©æ¯ = å¿…ç„¶ç ´äº§</strong>
      </div>
    </div>
    <div class="formula-box">
      <div style="color:rgba(255,255,255,0.7);margin-bottom:10px;">ç ´äº§æ—¶é—´ä¼°ç®—ï¼ˆç®€åŒ–ï¼‰</div>
      <div class="formula">T â‰ˆ Wâ‚€ / (E_avg - Wâ‚€ Ã— r/12)</div>
      <div class="formula-desc">
        å½“æœˆå‡æ”¯å‡º > æœˆæŠ•èµ„æ”¶ç›Šæ—¶ï¼Œç ´äº§æ—¶é—´ â‰ˆ æ€»èµ„äº§ / æœˆå‡€æµå‡º<br>
        1000ä¸‡ä¸­å¥–ï¼ŒæœˆèŠ±15ä¸‡ï¼Œå¹´å›æŠ¥5% â†’ çº¦ <strong style="color:#ff6b6b;">6.5å¹´</strong> ç ´äº§
      </div>
    </div>
  </div>

  <!-- æ¨¡æ‹Ÿå™¨1ï¼šä¸ªäººè´¢å¯Œè¡°å‡ -->
  <div class="card">
    <h2 style="color:#feca57;margin-bottom:15px;text-align:center;"><i class="ti ti-chart-line"></i> æ¨¡æ‹Ÿå™¨ï¼šä½ çš„ä¸­å¥–é‡‘èƒ½æ’‘å¤šä¹…ï¼Ÿ</h2>
    <p style="text-align:center;color:rgba(255,255,255,0.6);font-size:13px;margin-bottom:20px;">
      è®¾å®šä¸­å¥–é‡‘é¢å’Œæ¶ˆè´¹ä¹ æƒ¯ï¼Œçœ‹çœ‹è´¢å¯Œå½’é›¶çš„é€Ÿåº¦
    </p>
    <div class="setup-grid">
      <div class="setup-item">
        <label>ä¸­å¥–é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label>
        <input type="number" id="prizeMoney" value="1000" min="100" step="100">
      </div>
      <div class="setup-item">
        <label>ä¸­å¥–å‰æœˆæ”¯å‡ºï¼ˆä¸‡å…ƒï¼‰</label>
        <input type="number" id="baseExpense" value="1" min="0.3" step="0.1">
      </div>
      <div class="setup-item">
        <label>å¹´æŠ•èµ„å›æŠ¥ç‡ï¼ˆ%ï¼‰</label>
        <input type="number" id="returnRate" value="4" min="0" max="20" step="0.5">
      </div>
    </div>

    <div class="factor-slider">
      <label><span>æ¶ˆè´¹è†¨èƒ€é€Ÿåº¦</span><span id="inflationLabel" style="color:#feca57;">ä¸­ç­‰ï¼ˆæœˆæ”¯å‡ºç¿»5å€ï¼‰</span></label>
      <input type="range" id="inflationLevel" min="1" max="5" value="3" step="1" oninput="updateInflationLabel()">
    </div>
    <div style="display:flex;justify-content:space-between;color:rgba(255,255,255,0.3);font-size:11px;margin-top:-10px;margin-bottom:15px;">
      <span>å…‹åˆ¶</span><span>å°å¹…è†¨èƒ€</span><span>ä¸­ç­‰</span><span>æŒ¥éœ</span><span>ç–¯ç‹‚æŒ¥éœ</span>
    </div>

    <div class="scenario-grid">
      <div class="scenario-card active" onclick="selectScenario('rational')">
        <h4><i class="ti ti-brain"></i> ç†æ€§äºº</h4>
        <div class="pct">4%</div>
        <div class="desc">åªèŠ±åˆ©æ¯ï¼Œæœ¬é‡‘ä¸åŠ¨<br>æœˆæ”¯å‡ºä»…å°å¹…å¢é•¿</div>
      </div>
      <div class="scenario-card" onclick="selectScenario('average')">
        <h4><i class="ti ti-user"></i> æ™®é€šä¸­å¥–è€…</h4>
        <div class="pct">75%</div>
        <div class="desc">ä¹°æˆ¿ä¹°è½¦å€Ÿé’±ç»™äº²å‹<br>æœˆæ”¯å‡ºç¿»5-10å€</div>
      </div>
      <div class="scenario-card" onclick="selectScenario('extreme')">
        <h4><i class="ti ti-flame"></i> å…¸å‹ç ´äº§è€…</h4>
        <div class="pct">95%</div>
        <div class="desc">è±ªå®…è±ªè½¦æŠ•èµ„å¤±è´¥<br>æœˆæ”¯å‡ºç¿»20å€ä»¥ä¸Š</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" onclick="runSingleSim()"><i class="ti ti-player-play"></i> å¼€å§‹æ¨¡æ‹Ÿ</button>
      <button class="btn btn-gold" onclick="runThreeScenarios()"><i class="ti ti-chart-bar"></i> ä¸‰ç§äººç”Ÿå¯¹æ¯”</button>
    </div>

    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-value gold" id="peakWealth">-</div>
        <div class="stat-label">è´¢å¯Œå³°å€¼</div>
      </div>
      <div class="stat-box">
        <div class="stat-value red" id="bankruptMonth">-</div>
        <div class="stat-label">ç ´äº§æœˆä»½</div>
      </div>
      <div class="stat-box">
        <div class="stat-value blue" id="totalSpent">-</div>
        <div class="stat-label">æ€»å…±èŠ±æ‰</div>
      </div>
      <div class="stat-box">
        <div class="stat-value green" id="totalEarned">-</div>
        <div class="stat-label">æŠ•èµ„æ”¶ç›Š</div>
      </div>
    </div>

    <div class="chart-container"><canvas id="wealthChart"></canvas></div>
  </div>

  <!-- æ¨¡æ‹Ÿå™¨2ï¼š1000äººè’™ç‰¹å¡æ´› -->
  <div class="card">
    <h2 style="color:#feca57;margin-bottom:15px;text-align:center;"><i class="ti ti-users"></i> è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿï¼š1000ä¸ªä¸­å¥–è€…çš„å‘½è¿</h2>
    <p style="text-align:center;color:rgba(255,255,255,0.6);font-size:13px;margin-bottom:20px;">
      æ¯ä¸ªäººçš„æ¶ˆè´¹è†¨èƒ€é€Ÿåº¦éšæœºï¼ŒæŠ•èµ„å›æŠ¥éšæœºæ³¢åŠ¨ï¼Œçœ‹çœ‹å¤šå°‘äººèƒ½æ´»è¿‡5å¹´
    </p>
    <div class="setup-grid" style="grid-template-columns: repeat(2,1fr);">
      <div class="setup-item">
        <label>ä¸­å¥–é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label>
        <input type="number" id="mcPrize" value="1000" min="100" step="100">
      </div>
      <div class="setup-item">
        <label>æ¨¡æ‹Ÿå¹´æ•°</label>
        <input type="number" id="mcYears" value="10" min="3" max="30" step="1">
      </div>
    </div>
    <div class="controls">
      <button class="btn btn-gold" onclick="runMonteCarlo()"><i class="ti ti-rocket"></i> æ¨¡æ‹Ÿ1000ä¸ªä¸­å¥–è€…</button>
    </div>
    <div class="result-grid" id="mcResults" style="display:none;">
      <div class="result-card">
        <h4><i class="ti ti-skull"></i> 5å¹´å†…ç ´äº§</h4>
        <div class="big-num red" id="mc5yr">-</div>
      </div>
      <div class="result-card">
        <h4><i class="ti ti-skull"></i> 10å¹´å†…ç ´äº§</h4>
        <div class="big-num red" id="mc10yr">-</div>
      </div>
      <div class="result-card">
        <h4><i class="ti ti-coin"></i> ä¸­ä½æ•°å‰©ä½™è´¢å¯Œ</h4>
        <div class="big-num gold" id="mcMedian">-</div>
      </div>
      <div class="result-card">
        <h4><i class="ti ti-trophy"></i> è´¢å¯Œå¢é•¿è€…</h4>
        <div class="big-num green" id="mcGrew">-</div>
      </div>
    </div>
    <div class="chart-container" style="height:280px;"><canvas id="mcChart"></canvas></div>
    <div style="margin-top:15px;">
      <div style="color:rgba(255,255,255,0.5);font-size:12px;margin-bottom:8px;">ç ´äº§ç‡éšæ—¶é—´å˜åŒ–</div>
      <div class="chart-container" style="height:220px;"><canvas id="bankruptRateChart"></canvas></div>
    </div>
  </div>

  <!-- å››å¤§é™·é˜±åˆ†æ -->
  <div class="card">
    <h2 style="color:#feca57;margin-bottom:15px;text-align:center;"><i class="ti ti-alert-octagon"></i> å››å¤§ç ´äº§é™·é˜±</h2>

    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('trap1',this)">æ¶ˆè´¹è†¨èƒ€</button>
      <button class="tab-btn" onclick="switchTab('trap2',this)">ç¤¾äº¤å‹åŠ›</button>
      <button class="tab-btn" onclick="switchTab('trap3',this)">æŠ•èµ„å¹»è§‰</button>
      <button class="tab-btn" onclick="switchTab('trap4',this)">é”šå®šæ•ˆåº”</button>
    </div>

    <div class="tab-content active" id="trap1">
      <div class="analysis">
        <h3><i class="ti ti-arrow-up-right"></i> é™·é˜±ä¸€ï¼šäº«ä¹é€‚åº”ä¸æ¶ˆè´¹è†¨èƒ€</h3>
        <p>
          å¿ƒç†å­¦ä¸Šå«<span class="safe">äº«ä¹è·‘æ­¥æœºï¼ˆHedonic Treadmillï¼‰</span>ï¼šäººå¯¹ä»»ä½•å¿«ä¹éƒ½ä¼šé€‚åº”ã€‚
          ä¸­å¥–åç¬¬ä¸€ä¸ªæœˆä¹°äº†è±ªè½¦ï¼Œå…´å¥‹æ„ŸæŒç»­ä¸¤å‘¨ï¼›ç¬¬äºŒä¸ªæœˆå°±è§‰å¾—"ä¹Ÿå°±é‚£æ ·"ï¼Œéœ€è¦æ›´å¤§çš„åˆºæ¿€ã€‚
        </p>
        <p>
          æ¶ˆè´¹è†¨èƒ€çš„æ•°å­¦å¾ˆæ®‹é…·ï¼šæœˆæ”¯å‡ºä»1ä¸‡æ¶¨åˆ°10ä¸‡ï¼Œ<span class="highlight">ä¸æ˜¯å¤šèŠ±äº†9ä¸‡ï¼Œè€Œæ˜¯çƒ§é’±é€Ÿåº¦å˜æˆäº†10å€</span>ã€‚
          1000ä¸‡çš„å¥–é‡‘ï¼ŒæœˆèŠ±1ä¸‡èƒ½æ’‘83å¹´ï¼ŒæœˆèŠ±10ä¸‡åªèƒ½æ’‘8.3å¹´ï¼ŒæœˆèŠ±30ä¸‡ä¸åˆ°3å¹´å°±æ²¡äº†ã€‚
        </p>
        <p>
          æ›´è¦å‘½çš„æ˜¯ï¼Œæ¶ˆè´¹é™çº§æ¯”æ¶ˆè´¹å‡çº§ç—›è‹¦å¾—å¤šã€‚ä»æœˆèŠ±30ä¸‡é™å›1ä¸‡ï¼Œå¿ƒç†ä¸Šç­‰äº<span class="highlight">å¤±å»äº†29ä¸‡</span>ï¼Œ
          è€ŒæŸå¤±åŒæ¶å‘Šè¯‰æˆ‘ä»¬ï¼Œå¤±å»çš„ç—›è‹¦æ˜¯å¾—åˆ°çš„2.5å€ã€‚æ‰€ä»¥å¤§å¤šæ•°äººå®å¯ç»§ç»­æŒ¥éœåˆ°ç ´äº§ï¼Œä¹Ÿä¸æ„¿ä¸»åŠ¨é™çº§ã€‚
        </p>
      </div>
    </div>

    <div class="tab-content" id="trap2">
      <div class="analysis">
        <h3><i class="ti ti-users"></i> é™·é˜±äºŒï¼šç¤¾äº¤å‹åŠ›ä¸è´¢å¯Œè½¬ç§»</h3>
        <p>
          ä¸­å¥–æ¶ˆæ¯ä¸€æ—¦ä¼ å¼€ï¼Œä½ ä¼šçªç„¶å¤šå‡ºå¾ˆå¤š"äº²æˆš"å’Œ"æœ‹å‹"ã€‚ç ”ç©¶æ˜¾ç¤ºï¼Œä¸­å¥–è€…å¹³å‡ä¼šè¢«
          <span class="highlight">è¶…è¿‡50ä¸ªäººè¦æ±‚å€Ÿé’±æˆ–èµ äºˆ</span>ã€‚
        </p>
        <p>
          è¿™ä¸æ˜¯ç®€å•çš„"å€Ÿé’±"é—®é¢˜ï¼Œè€Œæ˜¯<span class="safe">åšå¼ˆè®ºå›°å¢ƒ</span>ï¼š
          æ‹’ç»å€Ÿé’± â†’ å…³ç³»ç ´è£‚ï¼Œè¢«è¯´"æœ‰é’±å°±å¿˜æœ¬"ï¼›
          åŒæ„å€Ÿé’± â†’ é’±æœ‰å»æ— å›ï¼Œè€Œä¸”ä¼šæœ‰æ›´å¤šäººæ¥å€Ÿã€‚
        </p>
        <p>
          ä½›ç½—é‡Œè¾¾å¤§å­¦çš„ç ”ç©¶å‘ç°ï¼Œä¸­å¥–è€…åœ¨ä¸­å¥–å3å¹´å†…ï¼Œå¹³å‡å‘äº²å‹è½¬ç§»äº†å¥–é‡‘çš„<span class="highlight">20%-30%</span>ã€‚
          è¿™äº›é’±å‡ ä¹ä¸å¯èƒ½æ”¶å›ã€‚
        </p>
      </div>
    </div>

    <div class="tab-content" id="trap3">
      <div class="analysis">
        <h3><i class="ti ti-chart-candle"></i> é™·é˜±ä¸‰ï¼šæŠ•èµ„å¹»è§‰ä¸è¾¾å…‹æ•ˆåº”</h3>
        <p>
          çªç„¶æœ‰äº†å¤§ç¬”é’±ï¼Œå¾ˆå¤šäººè§‰å¾—è‡ªå·±åº”è¯¥"è®©é’±ç”Ÿé’±"ã€‚ä½†<span class="highlight">æœ‰é’± â‰  ä¼šæŠ•èµ„</span>ã€‚
        </p>
        <p>
          è¾¾å…‹æ•ˆåº”ï¼ˆDunning-Kruger Effectï¼‰ï¼šèƒ½åŠ›è¶Šä½çš„äººè¶Šé«˜ä¼°è‡ªå·±ã€‚ä¸­å¥–è€…æ²¡æœ‰æŠ•èµ„ç»éªŒï¼Œ
          å´è§‰å¾—"æˆ‘è¿æ°”è¿™ä¹ˆå¥½ï¼ŒæŠ•èµ„è‚¯å®šä¹Ÿè¡Œ"ã€‚ç»“æœå¾€å¾€æ˜¯ï¼š
        </p>
        <p>
          <span class="highlight">è¢«éª—æŠ•èµ„</span>ï¼šäº²å‹æ¨èçš„"å¥½é¡¹ç›®"ã€"ç¨³èµšä¸èµ”çš„ç”Ÿæ„"<br>
          <span class="highlight">ç›²ç›®åˆ›ä¸š</span>ï¼šå¼€é¤å…ã€å¼€åº—ï¼Œ90%çš„æ–°ä¼ä¸šåœ¨5å¹´å†…å€’é—­<br>
          <span class="highlight">é«˜é£é™©æŠ•æœº</span>ï¼šç‚’è‚¡ã€ç‚’å¸ã€æœŸè´§ï¼Œæ²¡æœ‰ä¸“ä¸šçŸ¥è¯†å°±æ˜¯é€é’±
        </p>
        <p>
          NBERçš„æ•°æ®æ˜¾ç¤ºï¼Œä¸­å¥–è€…çš„æŠ•èµ„å¤±è´¥ç‡è¿œé«˜äºæ™®é€šæŠ•èµ„è€…ï¼Œå› ä¸ºä»–ä»¬<span class="safe">åŒæ—¶ç¼ºä¹çŸ¥è¯†å’Œé£é™©æ„è¯†</span>ã€‚
        </p>
      </div>
    </div>

    <div class="tab-content" id="trap4">
      <div class="analysis">
        <h3><i class="ti ti-anchor"></i> é™·é˜±å››ï¼šé”šå®šæ•ˆåº”ä¸å¿ƒç†è´¦æˆ·</h3>
        <p>
          ä¸­å¥–1000ä¸‡åï¼Œä½ çš„å¿ƒç†é”šç‚¹å˜æˆäº†"æˆ‘æ˜¯åƒä¸‡å¯Œç¿"ã€‚æ‰€æœ‰æ¶ˆè´¹å†³ç­–éƒ½ä»¥è¿™ä¸ªé”šç‚¹ä¸ºå‚ç…§ï¼š
          50ä¸‡çš„è½¦ï¼Ÿ"æ‰æˆ‘èµ„äº§çš„5%"ã€‚200ä¸‡çš„æˆ¿ï¼Ÿ"æ‰20%"ã€‚
        </p>
        <p>
          è¿™å°±æ˜¯<span class="safe">å¿ƒç†è´¦æˆ·ï¼ˆMental Accountingï¼‰</span>çš„é™·é˜±ï¼š
          ä½ æŠŠä¸­å¥–çš„é’±æ”¾åœ¨"æ„å¤–ä¹‹è´¢"è´¦æˆ·é‡Œï¼ŒèŠ±èµ·æ¥æ¯«ä¸å¿ƒç–¼ã€‚
          ç ”ç©¶è¡¨æ˜ï¼Œäººä»¬èŠ±"æ„å¤–ä¹‹è´¢"çš„é€Ÿåº¦æ˜¯èŠ±å·¥èµ„çš„<span class="highlight">2-3å€</span>ã€‚
        </p>
        <p>
          æ›´è‡´å‘½çš„æ˜¯<span class="highlight">é”šå®šä¸‹ç§»</span>ï¼šå½“1000ä¸‡èŠ±åˆ°åªå‰©200ä¸‡æ—¶ï¼Œ
          ä½ çš„é”šç‚¹è¿˜åœç•™åœ¨"åƒä¸‡å¯Œç¿"ï¼Œæ¶ˆè´¹ä¹ æƒ¯æ¥ä¸åŠè°ƒæ•´ï¼Œæœ€å200ä¸‡ä¼šä»¥æ›´å¿«çš„é€Ÿåº¦æ¶ˆå¤±ã€‚
        </p>
      </div>
    </div>
  </div>

  <!-- å®‰å…¨çº¿è®¡ç®—å™¨ -->
  <div class="card">
    <h2 style="color:#feca57;margin-bottom:15px;text-align:center;"><i class="ti ti-shield-check"></i> å®‰å…¨çº¿è®¡ç®—å™¨ï¼šä¸­äº†å¤§å¥–è¯¥æ€ä¹ˆèŠ±ï¼Ÿ</h2>
    <p style="text-align:center;color:rgba(255,255,255,0.6);font-size:13px;margin-bottom:20px;">
      4%æ³•åˆ™ï¼šæ¯å¹´åªèŠ±æ€»èµ„äº§çš„4%ï¼Œç†è®ºä¸Šæ°¸è¿œèŠ±ä¸å®Œ
    </p>
    <div class="setup-grid" style="grid-template-columns: repeat(2,1fr);">
      <div class="setup-item">
        <label>ä¸­å¥–é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label>
        <input type="number" id="safePrize" value="1000" min="100" step="100" oninput="calcSafeLine()">
      </div>
      <div class="setup-item">
        <label>å¹´æŠ•èµ„å›æŠ¥ç‡ï¼ˆ%ï¼‰</label>
        <input type="number" id="safeReturn" value="5" min="1" max="15" step="0.5" oninput="calcSafeLine()">
      </div>
    </div>
    <div class="stats-row" style="grid-template-columns: repeat(3,1fr);">
      <div class="stat-box">
        <div class="stat-value green" id="safeMonthly">-</div>
        <div class="stat-label">æ¯æœˆå®‰å…¨æ”¯å‡ºï¼ˆ4%æ³•åˆ™ï¼‰</div>
      </div>
      <div class="stat-box">
        <div class="stat-value gold" id="safeYearly">-</div>
        <div class="stat-label">æ¯å¹´å®‰å…¨æ”¯å‡º</div>
      </div>
      <div class="stat-box">
        <div class="stat-value blue" id="safeForever">-</div>
        <div class="stat-label">ç†è®ºå¯æŒç»­</div>
      </div>
    </div>
    <div style="margin-top:15px;">
      <div style="color:rgba(255,255,255,0.5);font-size:12px;margin-bottom:5px;">ä½ çš„æ¶ˆè´¹å®‰å…¨åº¦</div>
      <div class="progress-bar">
        <div class="progress-fill" id="safeProgress" style="width:50%;background:linear-gradient(90deg,#4ade80,#feca57);">å®‰å…¨</div>
      </div>
      <div style="display:flex;justify-content:space-between;color:rgba(255,255,255,0.3);font-size:11px;margin-top:5px;">
        <span>æ°¸ç»­</span><span>30å¹´</span><span>10å¹´</span><span>5å¹´</span><span>ç ´äº§</span>
      </div>
    </div>
  </div>

  <!-- ç»“è®º -->
  <div class="card conclusion">
    <h3><i class="ti ti-target"></i> ç»“è®º</h3>
    <p>
      å½©ç¥¨ä¸­å¥–è€…ç ´äº§ç‡æ˜¯æ™®é€šäººçš„2å€ï¼Œä¸æ˜¯å› ä¸ºä»–ä»¬æ¯”æ™®é€šäººè ¢ï¼Œ<br>
      è€Œæ˜¯å› ä¸º<span class="key-point">çªç„¶çš„å·¨é¢è´¢å¯Œè§¦å‘äº†ä¸€ç³»åˆ—å¿ƒç†é™·é˜±</span>ã€‚<br><br>
      äº«ä¹é€‚åº”è®©ä½ æ°¸è¿œä¸æ»¡è¶³ï¼Œç¤¾äº¤å‹åŠ›è®©ä½ ä¸æ–­å¤±è¡€ï¼Œ<br>
      æŠ•èµ„å¹»è§‰è®©ä½ åŠ é€ŸäºæŸï¼Œé”šå®šæ•ˆåº”è®©ä½ æ— æ³•åˆ¹è½¦ã€‚<br><br>
      <span style="color:rgba(255,255,255,0.6);">
        çœŸæ­£çš„è´¢å¯Œè‡ªç”±ä¸æ˜¯é“¶è¡Œå¡é‡Œæœ‰å¤šå°‘é›¶ï¼Œ<br>
        è€Œæ˜¯è¢«åŠ¨æ”¶å…¥ > æ—¥å¸¸æ”¯å‡ºã€‚<br>
        ä¸­äº†1000ä¸‡ï¼Œæ¯æœˆåªèŠ±3.3ä¸‡ï¼Œä½ å°±æ˜¯æ°¸è¿œçš„å¯Œäººã€‚<br>
        æœˆèŠ±30ä¸‡ï¼Œä½ åªæ˜¯ä¸€ä¸ª<span class="key-point">å€’è®¡æ—¶3å¹´çš„ç©·äºº</span>ã€‚
      </span>
    </p>
  </div>
</div>

<button class="copy-btn" onclick="copyShareText()"><i class="ti ti-clipboard"></i> å¤åˆ¶åˆ†äº«</button>
<div class="toast" id="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

<script>
// ========== æ ¸å¿ƒç®—æ³•ï¼ˆå¯ç‹¬ç«‹æµ‹è¯•ï¼‰ ==========

/**
 * æ¨¡æ‹Ÿå•ä¸ªä¸­å¥–è€…çš„è´¢å¯Œå˜åŒ–
 * @param {number} prize - ä¸­å¥–é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰
 * @param {number} baseExpense - ä¸­å¥–å‰æœˆæ”¯å‡ºï¼ˆä¸‡å…ƒï¼‰
 * @param {number} expenseMultiplier - ä¸­å¥–åæ”¯å‡ºè†¨èƒ€å€æ•°
 * @param {number} annualReturn - å¹´æŠ•èµ„å›æŠ¥ç‡ï¼ˆå°æ•°ï¼‰
 * @param {number} months - æ¨¡æ‹Ÿæœˆæ•°
 * @param {object} options - å¯é€‰å‚æ•°
 * @returns {object} æ¨¡æ‹Ÿç»“æœ
 */
function simulateWealth(prize, baseExpense, expenseMultiplier, annualReturn, months, options) {
  options = options || {};
  const monthlyReturn = annualReturn / 12;
  // æ”¯å‡ºä»åŸºç¡€å€¼é€æ¸è†¨èƒ€åˆ°å³°å€¼ï¼Œç”¨logisticæ›²çº¿æ¨¡æ‹Ÿ
  // å‰å‡ ä¸ªæœˆå¿«é€Ÿè†¨èƒ€ï¼Œç„¶åè¶‹äºç¨³å®š
  const peakExpense = baseExpense * expenseMultiplier;
  const rampSpeed = options.rampSpeed || 0.15; // è†¨èƒ€é€Ÿåº¦

  let wealth = prize;
  const history = [wealth];
  let totalSpent = 0;
  let totalEarned = 0;
  let bankruptMonth = -1;
  let peakWealth = prize;

  for (let m = 1; m <= months; m++) {
    if (wealth <= 0) {
      history.push(0);
      continue;
    }
    // æŠ•èµ„æ”¶ç›Šï¼ˆå¯åŠ éšæœºæ³¢åŠ¨ï¼‰
    let returnRate = monthlyReturn;
    if (options.randomReturn) {
      // æ­£æ€åˆ†å¸ƒæ³¢åŠ¨ï¼Œå¹´åŒ–æ ‡å‡†å·®çº¦15%
      returnRate = monthlyReturn + (randn() * 0.15 / Math.sqrt(12));
    }
    const earnings = wealth * returnRate;
    totalEarned += Math.max(0, earnings);

    // æ”¯å‡ºï¼šlogisticè†¨èƒ€æ›²çº¿
    const inflationFactor = 1 + (expenseMultiplier - 1) / (1 + Math.exp(-rampSpeed * (m - 6)));
    let expense = baseExpense * inflationFactor;

    // éšæœºæ”¯å‡ºå†²å‡»ï¼ˆå¤§é¢æ¶ˆè´¹äº‹ä»¶ï¼‰
    if (options.randomShocks && Math.random() < 0.02) {
      expense += prize * (0.03 + Math.random() * 0.07); // 3%-10%çš„ä¸€æ¬¡æ€§å¤§é¢æ”¯å‡º
    }

    totalSpent += expense;
    wealth = wealth + earnings - expense;

    if (wealth > peakWealth) peakWealth = wealth;
    if (wealth <= 0 && bankruptMonth === -1) {
      bankruptMonth = m;
      wealth = 0;
    }
    history.push(Math.max(0, wealth));
  }

  return { history, totalSpent, totalEarned, bankruptMonth, peakWealth, finalWealth: Math.max(0, wealth) };
}

/**
 * è®¡ç®—4%æ³•åˆ™çš„å®‰å…¨æ”¯å‡º
 */
function calcSafeWithdrawal(prize, annualReturn) {
  const safeRate = 0.04; // 4%æ³•åˆ™
  const yearlyWithdrawal = prize * safeRate;
  const monthlyWithdrawal = yearlyWithdrawal / 12;
  // å¦‚æœå›æŠ¥ç‡ >= 4%ï¼Œç†è®ºä¸Šæ°¸ç»­
  const sustainable = annualReturn >= safeRate;
  return { monthlyWithdrawal, yearlyWithdrawal, sustainable };
}

/**
 * è®¡ç®—ç ´äº§æ—¶é—´ï¼ˆç®€åŒ–å…¬å¼ï¼Œä¸è€ƒè™‘æ”¯å‡ºå¢é•¿ï¼‰
 */
function calcBankruptTime(prize, monthlyExpense, annualReturn) {
  const monthlyReturn = annualReturn / 12;
  const netBurn = monthlyExpense - prize * monthlyReturn;
  if (netBurn <= 0) return Infinity; // æ”¶ç›Šè¦†ç›–æ”¯å‡ºï¼Œä¸ä¼šç ´äº§
  return prize / netBurn; // æœˆæ•°
}

/**
 * Box-Muller æ­£æ€åˆ†å¸ƒéšæœºæ•°
 */
function randn() {
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

// ========== UI é€»è¾‘ ==========
let wealthChart = null, mcChart = null, bankruptRateChart = null;

const INFLATION_LEVELS = {
  1: { mult: 2, label: 'å…‹åˆ¶ï¼ˆæœˆæ”¯å‡ºç¿»2å€ï¼‰' },
  2: { mult: 3.5, label: 'å°å¹…è†¨èƒ€ï¼ˆæœˆæ”¯å‡ºç¿»3.5å€ï¼‰' },
  3: { mult: 5, label: 'ä¸­ç­‰ï¼ˆæœˆæ”¯å‡ºç¿»5å€ï¼‰' },
  4: { mult: 12, label: 'æŒ¥éœï¼ˆæœˆæ”¯å‡ºç¿»12å€ï¼‰' },
  5: { mult: 25, label: 'ç–¯ç‹‚æŒ¥éœï¼ˆæœˆæ”¯å‡ºç¿»25å€ï¼‰' }
};

function updateInflationLabel() {
  const level = document.getElementById('inflationLevel').value;
  document.getElementById('inflationLabel').textContent = INFLATION_LEVELS[level].label;
}

function selectScenario(type) {
  document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
  event.currentTarget.classList.add('active');
  if (type === 'rational') {
    document.getElementById('inflationLevel').value = 1;
    document.getElementById('returnRate').value = 5;
  } else if (type === 'average') {
    document.getElementById('inflationLevel').value = 3;
    document.getElementById('returnRate').value = 3;
  } else {
    document.getElementById('inflationLevel').value = 5;
    document.getElementById('returnRate').value = 1;
  }
  updateInflationLabel();
}

function runSingleSim() {
  const prize = parseFloat(document.getElementById('prizeMoney').value) || 1000;
  const baseExp = parseFloat(document.getElementById('baseExpense').value) || 1;
  const returnRate = (parseFloat(document.getElementById('returnRate').value) || 4) / 100;
  const level = document.getElementById('inflationLevel').value;
  const mult = INFLATION_LEVELS[level].mult;

  const result = simulateWealth(prize, baseExp, mult, returnRate, 120); // 10å¹´

  // æ›´æ–°ç»Ÿè®¡
  document.getElementById('peakWealth').textContent = formatMoney(result.peakWealth);
  document.getElementById('bankruptMonth').textContent = result.bankruptMonth > 0
    ? (result.bankruptMonth < 12 ? result.bankruptMonth + 'ä¸ªæœˆ' : (result.bankruptMonth / 12).toFixed(1) + 'å¹´')
    : 'æœªç ´äº§';
  document.getElementById('bankruptMonth').className = 'stat-value ' + (result.bankruptMonth > 0 ? 'red' : 'green');
  document.getElementById('totalSpent').textContent = formatMoney(result.totalSpent);
  document.getElementById('totalEarned').textContent = formatMoney(result.totalEarned);

  // ç”»å›¾
  drawWealthChart([{ name: INFLATION_LEVELS[level].label, data: result.history, color: result.bankruptMonth > 0 ? '#ff6b6b' : '#4ade80' }]);
}

function runThreeScenarios() {
  const prize = parseFloat(document.getElementById('prizeMoney').value) || 1000;
  const baseExp = parseFloat(document.getElementById('baseExpense').value) || 1;

  const scenarios = [
    { name: 'ç†æ€§äººï¼ˆÃ—2ï¼Œå›æŠ¥5%ï¼‰', mult: 2, ret: 0.05, color: '#4ade80' },
    { name: 'æ™®é€šä¸­å¥–è€…ï¼ˆÃ—5ï¼Œå›æŠ¥3%ï¼‰', mult: 5, ret: 0.03, color: '#feca57' },
    { name: 'å…¸å‹ç ´äº§è€…ï¼ˆÃ—25ï¼Œå›æŠ¥1%ï¼‰', mult: 25, ret: 0.01, color: '#ff6b6b' }
  ];

  const results = scenarios.map(s => {
    const r = simulateWealth(prize, baseExp, s.mult, s.ret, 120);
    return { name: s.name, data: r.history, color: s.color };
  });

  drawWealthChart(results);

  // æ›´æ–°ç»Ÿè®¡ä¸ºæ™®é€šä¸­å¥–è€…
  const avg = simulateWealth(prize, baseExp, 5, 0.03, 120);
  document.getElementById('peakWealth').textContent = formatMoney(avg.peakWealth);
  document.getElementById('bankruptMonth').textContent = avg.bankruptMonth > 0
    ? (avg.bankruptMonth < 12 ? avg.bankruptMonth + 'ä¸ªæœˆ' : (avg.bankruptMonth / 12).toFixed(1) + 'å¹´')
    : 'æœªç ´äº§';
  document.getElementById('bankruptMonth').className = 'stat-value ' + (avg.bankruptMonth > 0 ? 'red' : 'green');
  document.getElementById('totalSpent').textContent = formatMoney(avg.totalSpent);
  document.getElementById('totalEarned').textContent = formatMoney(avg.totalEarned);
}

function drawWealthChart(datasets) {
  const ctx = document.getElementById('wealthChart').getContext('2d');
  if (wealthChart) wealthChart.destroy();

  const maxLen = Math.max(...datasets.map(d => d.data.length));
  const labels = Array.from({ length: maxLen }, (_, i) => {
    if (i % 12 === 0) return 'ç¬¬' + (i / 12) + 'å¹´';
    return '';
  });

  wealthChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: datasets.map(d => ({
        label: d.name,
        data: d.data,
        borderColor: d.color,
        backgroundColor: 'transparent',
        tension: 0.3,
        pointRadius: 0,
        borderWidth: 2
      }))
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: datasets.length > 1, labels: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } } } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', maxTicksLimit: 11 } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', callback: v => formatMoney(v) }, min: 0 }
      }
    }
  });
}

function runMonteCarlo() {
  const prize = parseFloat(document.getElementById('mcPrize').value) || 1000;
  const years = parseInt(document.getElementById('mcYears').value) || 10;
  const months = years * 12;
  const N = 1000;

  const results = [];
  const bankruptByMonth = new Array(months + 1).fill(0);

  for (let i = 0; i < N; i++) {
    // éšæœºå‚æ•°ï¼šæ¶ˆè´¹è†¨èƒ€å€æ•° 2~30ï¼ŒåŸºç¡€æ”¯å‡º 0.5~2ä¸‡ï¼Œå›æŠ¥ç‡ 0~8%
    const basExp = 0.5 + Math.random() * 1.5;
    const mult = 2 + Math.random() * 28; // å¤§éƒ¨åˆ†äººä¼šè†¨èƒ€
    const ret = Math.random() * 0.08;
    const r = simulateWealth(prize, basExp, mult, ret, months, { randomReturn: true, randomShocks: true, rampSpeed: 0.1 + Math.random() * 0.3 });
    results.push(r);
    if (r.bankruptMonth > 0) {
      for (let m = r.bankruptMonth; m <= months; m++) {
        bankruptByMonth[m]++;
      }
    }
  }

  // ç»Ÿè®¡
  const bankrupt5yr = results.filter(r => r.bankruptMonth > 0 && r.bankruptMonth <= 60).length;
  const bankrupt10yr = results.filter(r => r.bankruptMonth > 0 && r.bankruptMonth <= Math.min(120, months)).length;
  const finals = results.map(r => r.finalWealth).sort((a, b) => a - b);
  const median = finals[500];
  const grew = results.filter(r => r.finalWealth > prize).length;

  document.getElementById('mcResults').style.display = 'grid';
  document.getElementById('mc5yr').textContent = bankrupt5yr + '/1000 (' + (bankrupt5yr / 10).toFixed(1) + '%)';
  document.getElementById('mc10yr').textContent = years >= 10
    ? bankrupt10yr + '/1000 (' + (bankrupt10yr / 10).toFixed(1) + '%)'
    : 'N/A';
  document.getElementById('mcMedian').textContent = formatMoney(median);
  document.getElementById('mcGrew').textContent = grew + '/1000 (' + (grew / 10).toFixed(1) + '%)';

  // æŠ½æ ·ç”»10æ¡è½¨è¿¹
  drawMCChart(results, months);
  drawBankruptRateChart(bankruptByMonth, months, N);
}

function drawMCChart(results, months) {
  const ctx = document.getElementById('mcChart').getContext('2d');
  if (mcChart) mcChart.destroy();

  // æŠ½10æ¡æœ‰ä»£è¡¨æ€§çš„è½¨è¿¹
  const sorted = [...results].sort((a, b) => a.finalWealth - b.finalWealth);
  const indices = [0, 100, 250, 400, 500, 600, 750, 900, 950, 999];
  const colors = ['#ff6b6b', '#ff8787', '#ffa07a', '#feca57', '#feca57', '#a8e6cf', '#88d8b0', '#4ade80', '#22c55e', '#16a34a'];

  const labels = Array.from({ length: sorted[0].history.length }, (_, i) => {
    if (i % 12 === 0) return 'ç¬¬' + (i / 12) + 'å¹´';
    return '';
  });

  mcChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: indices.map((idx, j) => ({
        label: 'P' + (idx / 10).toFixed(0) + '%',
        data: sorted[idx].history,
        borderColor: colors[j],
        backgroundColor: 'transparent',
        tension: 0.3,
        pointRadius: 0,
        borderWidth: 1.5
      }))
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: true, labels: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } } } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', maxTicksLimit: 11 } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', callback: v => formatMoney(v) }, min: 0 }
      }
    }
  });
}

function drawBankruptRateChart(bankruptByMonth, months, N) {
  const ctx = document.getElementById('bankruptRateChart').getContext('2d');
  if (bankruptRateChart) bankruptRateChart.destroy();

  // æ¯å¹´é‡‡æ ·ä¸€æ¬¡
  const yearlyData = [];
  const labels = [];
  for (let y = 0; y <= months / 12; y++) {
    const m = y * 12;
    labels.push('ç¬¬' + y + 'å¹´');
    yearlyData.push(((bankruptByMonth[m] || 0) / N * 100).toFixed(1));
  }

  bankruptRateChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'ç´¯è®¡ç ´äº§ç‡(%)',
        data: yearlyData,
        backgroundColor: yearlyData.map(v => v > 50 ? 'rgba(255,107,107,0.7)' : v > 25 ? 'rgba(254,202,87,0.7)' : 'rgba(74,222,128,0.7)'),
        borderRadius: 6
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)' } },
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.4)', callback: v => v + '%' }, max: 100, min: 0 }
      }
    }
  });
}

// ========== å®‰å…¨çº¿è®¡ç®—å™¨ ==========
function calcSafeLine() {
  const prize = parseFloat(document.getElementById('safePrize').value) || 1000;
  const ret = (parseFloat(document.getElementById('safeReturn').value) || 5) / 100;
  const result = calcSafeWithdrawal(prize, ret);

  document.getElementById('safeMonthly').textContent = result.monthlyWithdrawal.toFixed(1) + 'ä¸‡';
  document.getElementById('safeYearly').textContent = result.yearlyWithdrawal.toFixed(0) + 'ä¸‡';
  document.getElementById('safeForever').textContent = result.sustainable ? 'æ°¸ç»­' : 'çº¦' + Math.floor(prize / (result.yearlyWithdrawal - prize * ret)) + 'å¹´';

  // è¿›åº¦æ¡ï¼šå®‰å…¨åº¦
  const safeRatio = (prize * ret) / (result.yearlyWithdrawal);
  const pct = Math.min(100, Math.max(5, safeRatio * 100));
  const bar = document.getElementById('safeProgress');
  bar.style.width = pct + '%';
  if (pct >= 80) {
    bar.style.background = 'linear-gradient(90deg,#4ade80,#22c55e)';
    bar.textContent = 'éå¸¸å®‰å…¨';
  } else if (pct >= 50) {
    bar.style.background = 'linear-gradient(90deg,#4ade80,#feca57)';
    bar.textContent = 'å®‰å…¨';
  } else if (pct >= 30) {
    bar.style.background = 'linear-gradient(90deg,#feca57,#ff8c00)';
    bar.textContent = 'æœ‰é£é™©';
  } else {
    bar.style.background = 'linear-gradient(90deg,#ff8c00,#ff6b6b)';
    bar.textContent = 'å±é™©';
  }
}

// ========== Tab åˆ‡æ¢ ==========
function switchTab(tabId, btn) {
  btn.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const card = btn.closest('.card');
  card.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
}

// ========== å·¥å…·å‡½æ•° ==========
function formatMoney(num) {
  if (num >= 10000) return (num / 10000).toFixed(1) + 'äº¿';
  if (num >= 100) return num.toFixed(0) + 'ä¸‡';
  if (num >= 1) return num.toFixed(1) + 'ä¸‡';
  if (num <= 0) return '0';
  return (num * 10000).toFixed(0) + 'å…ƒ';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function copyShareText() {
  const text = 'ã€å½©ç¥¨å¤´å¥–å¾—ä¸»ä¸ºä»€ä¹ˆå¤§å¤šç ´äº§ï¼Ÿã€‘\n75%çš„ä¸­å¥–è€…åœ¨5å¹´å†…ç ´äº§ã€‚ä¸æ˜¯è¿æ°”é—®é¢˜ï¼Œæ˜¯æ•°å­¦å’Œå¿ƒç†çš„åŒé‡é™·é˜±ã€‚\n\nä¸­äº†1000ä¸‡ï¼ŒæœˆèŠ±3.3ä¸‡èƒ½èŠ±ä¸€è¾ˆå­ï¼›æœˆèŠ±30ä¸‡ï¼Œ3å¹´å°±æ²¡äº†ã€‚\n\næ¥è¯•è¯•è´¢å¯Œè¡°å‡æ¨¡æ‹Ÿå™¨ ğŸ‘‰ ' + window.location.href;
  navigator.clipboard.writeText(text).then(() => showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
}

// åˆå§‹åŒ–
calcSafeLine();
</script>
</body>
</html>
